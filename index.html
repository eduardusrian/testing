
<!doctype html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEE Digital Monitoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body, #app-wrapper {
            height: 100%;
            width: 100%;
        }
        
        #app-wrapper {
            overflow-y: auto;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            transition: background 0.3s ease;
        }
        
        .theme-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .theme-toggle:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
        }
        
        .theme-toggle:active {
            transform: translateY(-2px) scale(1.02);
        }
        
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e2e8f0;
            --gradient-start: #667eea;
            --gradient-end: #764ba2;
        }
        
        [data-theme="dark"] {
            --bg-primary: #1e293b;
            --bg-secondary: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-primary: #818cf8;
            --accent-secondary: #a78bfa;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --border: #334155;
            --gradient-start: #4c1d95;
            --gradient-end: #1e1b4b;
        }
        
        .container-main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .card {
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 24px;
        }
        
        .card-header {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 125, 234, 0.3);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2525;
        }
        
        .input-field {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(102, 125, 234, 0.1);
        }
        
        .label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .scorecard {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border);
            text-align: center;
        }
        
        .scorecard-value {
            font-size: 36px;
            font-weight: 900;
            margin: 8px 0;
        }
        
        .scorecard-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .scorecard.good .scorecard-value {
            color: var(--success);
        }
        
        .scorecard.bad .scorecard-value {
            color: var(--danger);
        }
        
        .nav-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            background: white;
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tab {
            padding: 14px 28px;
            background: linear-gradient(135deg, rgba(102, 125, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid transparent;
            border-radius: 12px;
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            font-size: 15px;
        }
        
        .nav-tab:hover {
            background: linear-gradient(135deg, rgba(102, 125, 234, 0.2), rgba(118, 75, 162, 0.2));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 125, 234, 0.3);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-color: var(--accent-primary);
            box-shadow: 0 6px 20px rgba(102, 125, 234, 0.4);
            transform: translateY(-2px);
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin: 0 -24px;
            padding: 0 24px;
            width: calc(100% + 48px);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            white-space: nowrap;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 300px;
            min-width: 80px;
        }
        
        tr:hover {
            background: var(--bg-secondary);
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .toast.success {
            background: var(--success);
        }
        
        .toast.error {
            background: var(--danger);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .spinner {
            border: 3px solid rgba(102, 125, 234, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            gap: 16px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-item.active {
            background: rgba(102, 125, 234, 0.1);
            border-color: var(--accent-primary);
        }
        
        .checkbox-item.exceed {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
        }
        
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 16px;
        }
        
        .chart-container-horizontal {
            position: relative;
            height: 400px;
            margin-top: 16px;
            padding-right: 60px;
        }
        
        .status-good {
            color: var(--success);
            font-weight: 600;
        }
        
        .status-bad {
            color: var(--danger);
            font-weight: 600;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .target-box {
            background: linear-gradient(135deg, rgba(102, 125, 234, 0.15), rgba(118, 75, 162, 0.15));
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 4px 12px rgba(102, 125, 234, 0.2);
        }
        
        .odt-exceed-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 12px;
            color: var(--warning);
            font-weight: 600;
        }
        
        /* Text wrapping and overflow fixes */
        .wrap-text {
            white-space: normal !important;
            word-wrap: break-word !important;
            word-break: break-word !important;
            overflow-wrap: break-word !important;
            max-width: 200px;
            min-width: 100px;
        }
        
        .nowrap {
            white-space: nowrap;
        }
        
        .ellipsis {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .notes-cell {
            max-width: 250px !important;
            min-width: 150px !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            word-break: break-word !important;
        }
        
        .wr-cell {
            max-width: 180px !important;
            min-width: 120px !important;
            white-space: normal !important;
            word-wrap: break-word !important;
        }
        
        /* Responsive styles */
        @media (min-width: 768px) and (max-width: 1024px) {
            .container-main {
                padding: 20px;
            }
            
            .table-wrapper {
                margin: 0 -20px;
                padding: 0 20px;
                width: calc(100% + 40px);
            }
            
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-section {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container {
                height: 280px;
            }
            
            .chart-container-horizontal {
                height: 350px;
                padding-right: 50px;
            }
            
            .scorecard-value {
                font-size: 32px;
            }
            
            table {
                min-width: 1000px;
            }
            
            td, th {
                padding: 10px;
                font-size: 13px;
            }
        }
        
        @media (min-width: 600px) and (max-width: 767px) {
            .container-main {
                padding: 16px;
            }
            
            .table-wrapper {
                margin: 0 -16px;
                padding: 0 16px;
                width: calc(100% + 32px);
            }
            
            .card {
                padding: 20px;
            }
            
            .card-header {
                font-size: 19px;
            }
            
            .grid-2 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-section {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .nav-tab {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .scorecard-value {
                font-size: 30px;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .chart-container-horizontal {
                height: 320px;
                padding-right: 40px;
            }
            
            table {
                min-width: 1100px;
                font-size: 13px;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
        
        @media (min-width: 480px) and (max-width: 599px) {
            .container-main {
                padding: 12px;
            }
            
            .table-wrapper {
                margin: 0 -12px;
                padding: 0 12px;
                width: calc(100% + 24px);
            }
            
            .card {
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .card-header {
                font-size: 17px;
            }
            
            .scorecard {
                padding: 16px;
            }
            
            .scorecard-value {
                font-size: 22px;
            }
            
            .scorecard-label {
                font-size: 11px;
            }
            
            .nav-tabs {
                padding: 10px;
                gap: 6px;
                flex-wrap: wrap;
            }
            
            .nav-tab {
                padding: 10px 14px;
                font-size: 13px;
                flex: 1 1 calc(50% - 6px);
                min-width: calc(50% - 6px);
                text-align: center;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .filter-section {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 11px 14px;
                font-size: 14px;
                width: 100%;
            }
            
            .chart-container {
                height: 240px;
            }
            
            .chart-container-horizontal {
                height: 300px;
                padding-right: 30px;
            }
            
            table {
                min-width: 1200px;
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 6px;
                white-space: nowrap;
            }
            
            .modal-content {
                padding: 20px;
                margin: 8px;
                max-height: 85vh;
                max-width: calc(100vw - 16px);
            }
            
            .toast {
                top: 10px;
                right: 10px;
                left: 10px;
                font-size: 14px;
                padding: 12px 16px;
            }
            
            .theme-toggle {
                width: 50px;
                height: 50px;
                bottom: 16px;
                right: 16px;
                font-size: 22px;
            }
        }
        
        @media (max-width: 479px) {
            .container-main {
                padding: 10px;
            }
            
            .table-wrapper {
                margin: 0 -10px;
                padding: 0 10px;
                width: calc(100% + 20px);
            }
            
            .card {
                padding: 14px;
                margin-bottom: 14px;
                border-radius: 12px;
            }
            
            .card-header {
                font-size: 16px;
                margin-bottom: 14px;
            }
            
            .scorecard {
                padding: 14px;
            }
            
            .scorecard-value {
                font-size: 20px;
            }
            
            .scorecard-label {
                font-size: 10px;
            }
            
            .nav-tabs {
                padding: 8px;
                gap: 6px;
                flex-direction: column;
            }
            
            .nav-tab {
                padding: 12px 16px;
                font-size: 13px;
                width: 100%;
                text-align: center;
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
                gap: 14px;
            }
            
            .filter-section {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .btn {
                padding: 12px 16px;
                font-size: 14px;
                width: 100%;
            }
            
            .chart-container {
                height: 220px;
            }
            
            .chart-container-horizontal {
                height: 280px;
                padding-right: 25px;
            }
            
            table {
                min-width: 1200px;
                font-size: 11px;
            }
            
            th, td {
                padding: 6px 4px;
            }
            
            .input-field {
                font-size: 14px;
                padding: 10px 12px;
            }
            
            .label {
                font-size: 13px;
                margin-bottom: 6px;
            }
            
            .modal-content {
                padding: 16px;
                margin: 8px;
                max-height: 90vh;
                max-width: calc(100vw - 16px);
                border-radius: 12px;
            }
            
            .toast {
                top: 8px;
                right: 8px;
                left: 8px;
                font-size: 13px;
                padding: 10px 14px;
                border-radius: 8px;
            }
            
            .theme-toggle {
                width: 48px;
                height: 48px;
                bottom: 12px;
                right: 12px;
                font-size: 20px;
            }
            
            .checkbox-item {
                padding: 10px;
                font-size: 13px;
            }
            
            .target-box {
                padding: 14px;
            }
            
            #target-text {
                font-size: 14px;
                padding: 10px;
            }
            
            #target-details {
                font-size: 12px;
            }
        }
        
        @media (max-width: 359px) {
            .container-main {
                padding: 8px;
            }
            
            .table-wrapper {
                margin: 0 -8px;
                padding: 0 8px;
                width: calc(100% + 16px);
            }
            
            .card {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .card-header {
                font-size: 15px;
                margin-bottom: 12px;
            }
            
            .scorecard {
                padding: 12px;
            }
            
            .scorecard-value {
                font-size: 18px;
            }
            
            .scorecard-label {
                font-size: 9px;
            }
            
            .nav-tab {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .btn {
                padding: 10px 12px;
                font-size: 13px;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .chart-container-horizontal {
                height: 250px;
                padding-right: 20px;
            }
            
            table {
                min-width: 1200px;
                font-size: 10px;
            }
            
            th, td {
                padding: 5px 3px;
            }
            
            .input-field {
                font-size: 13px;
                padding: 8px 10px;
            }
            
            .theme-toggle {
                width: 44px;
                height: 44px;
                bottom: 10px;
                right: 10px;
                font-size: 18px;
            }
        }
        
        /* ODT Error Styling */
        .odt-error {
            display: none;
            color: var(--danger);
            font-size: 11px;
            margin-top: 4px;
            padding-left: 32px;
        }
        
        .odt-input-error {
            border-color: var(--danger) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }
        
        /* Chart Total Badge - DIPERBAIKI POSISI DAN UKURAN */
        .chart-total-badge {
            position: absolute;
            top: 5px; /* DIPINDAH KE BAWAH AGAR TIDAK NABRAK HEADER */
            right: 15px; /* DIPINDAH KE KIRI SEDIKIT */
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 6px 12px; /* DIPERKECIL PADDING */
            border-radius: 16px; /* DIBUAT LEBIH BULAT */
            font-size: 12px; /* DIPERKECIL FONT */
            font-weight: 700;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap; /* AGAR TIDAK PECAH BARIS */
        }
        
        /* Responsive untuk badge total chart */
        @media (max-width: 1024px) {
            .chart-total-badge {
                top: 40px;
                right: 12px;
                padding: 5px 10px;
                font-size: 11px;
            }
        }
        
        @media (max-width: 767px) {
            .chart-total-badge {
                top: 35px;
                right: 10px;
                padding: 4px 8px;
                font-size: 10px;
            }
        }
        
        @media (max-width: 479px) {
            .chart-total-badge {
                top: 30px;
                right: 8px;
                padding: 3px 6px;
                font-size: 9px;
            }
        }
    </style>
</head>
<body class="h-full">
    <div id="app-wrapper" class="h-full w-full"></div>
    <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle-btn" aria-label="Toggle dark mode"> üåô </button>

    <script>
        // =============================================
        // üî• SUPABASE CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://ehespstzpubqkovkykby.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoZXNwc3R6cHVicWtvdmt5a2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1MDY4MjUsImV4cCI6MjA4MTA4MjgyNX0.XTuuHksJVe8ZEwcN5gshXNz7WqEWVPr10eIsYO-zar4';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // =============================================
        // THEME MANAGEMENT
        // =============================================
        function initializeTheme() {
            const savedTheme = localStorage.getItem('oee-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('oee-theme', newTheme);
            updateThemeIcon(newTheme);
            
            showToast(`${newTheme === 'dark' ? 'üåô Dark' : '‚òÄÔ∏è Light'} mode activated`, 'success');
        }
        
        function updateThemeIcon(theme) {
            const btn = document.getElementById('theme-toggle-btn');
            if (btn) {
                btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }
        
        // =============================================
        // STATE & CONSTANTS
        // =============================================
        const defaultConfig = {
            system_title: "OEE Monitoring System PT. GOF",
            company_name: "Created by MSTD GOF"
        };

        let currentPage = 'dashboard';
        let allMachines = [];
        let allOEERecords = [];
        let isManagementUnlocked = false;
        let chartInstances = {};
        
        const MANAGEMENT_PASSWORD = 'admin123';
        
        const SHIFTS = {
            'Shift 1': { start: '07:00', end: '15:30', minutes: 510 },
            'Shift 2': { start: '15:20', end: '22:50', minutes: 450 },
            'Shift 3': { start: '22:40', end: '07:10', minutes: 530 },
            'Longshift Pagi': { start: '07:00', end: '19:00', minutes: 720 },
            'Longshift Malam': { start: '19:00', end: '07:00', minutes: 720 }
        };

        // =============================================
        // UTILITY FUNCTIONS - TANGGAL BULAN INI
        // =============================================
        function getCurrentMonthStart() {
            const date = new Date();
            date.setDate(1); // Set ke tanggal 1
            return date.toISOString().split('T')[0];
        }
        
        function getCurrentMonthEnd() {
            const date = new Date();
            date.setMonth(date.getMonth() + 1); // Ke bulan depan
            date.setDate(0); // Set ke tanggal terakhir bulan ini
            return date.toISOString().split('T')[0];
        }

        // Filter state - DIMULAI DARI AWAL BULAN HINGGA AKHIR BULAN
        let filters = {
            startDate: getCurrentMonthStart(),
            endDate: getCurrentMonthEnd(),
            shift: 'all',
            machine: 'all',
            pic: 'all'
        };

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function showLoading(message = 'Loading...') {
            const overlay = document.createElement('div');
            overlay.id = 'loading-overlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="spinner"></div>
                <p style="color: white; font-weight: 600; font-size: 16px;">${message}</p>
            `;
            document.body.appendChild(overlay);
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) overlay.remove();
        }

        function showModal(content) {
            const modal = document.createElement('div');
            modal.id = 'modal';
            modal.className = 'modal-overlay';
            modal.innerHTML = `<div class="modal-content">${content}</div>`;
            modal.onclick = (e) => {
                if (e.target === modal) closeModal();
            };
            document.body.appendChild(modal);
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) modal.remove();
        }

        // =============================================
        // DATABASE FUNCTIONS
        // =============================================
        async function loadMachines() {
            try {
                const { data, error } = await db
                    .from('machines')
                    .select('*')
                    .eq('is_deleted', false)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                allMachines = data || [];
                return allMachines;
            } catch (error) {
                console.error('Error loading machines:', error);
                showToast('Failed to load machines', 'error');
                return [];
            }
        }

        async function loadMachineDetails(machineId) {
            try {
                const [odtRes, lsmRes, lsnmRes, msRes] = await Promise.all([
                    db.from('machine_odt').select('*').eq('machine_id', machineId),
                    db.from('machine_line_stop_mesin').select('*').eq('machine_id', machineId),
                    db.from('machine_line_stop_non_mesin').select('*').eq('machine_id', machineId),
                    db.from('machine_minor_stop').select('*').eq('machine_id', machineId)
                ]);
                
                return {
                    odt: odtRes.data || [],
                    lineStopMesin: lsmRes.data || [],
                    lineStopNonMesin: lsnmRes.data || [],
                    minorStop: msRes.data || []
                };
            } catch (error) {
                console.error('Error loading machine details:', error);
                return { odt: [], lineStopMesin: [], lineStopNonMesin: [], minorStop: [] };
            }
        }

        async function loadOEERecords() {
            try {
                const { data, error } = await db
                    .from('oee_records')
                    .select('*')
                    .order('date', { ascending: false })
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                allOEERecords = data || [];
                return allOEERecords;
            } catch (error) {
                console.error('Error loading OEE records:', error);
                showToast('Failed to load OEE records', 'error');
                return [];
            }
        }

        async function saveMachine(machineData, odtItems, lineStopMesinItems, lineStopNonMesinItems, minorStopItems) {
            try {
                const { data: machine, error: machineError } = await db
                    .from('machines')
                    .insert([machineData])
                    .select()
                    .single();
                
                if (machineError) throw machineError;
                
                const machineId = machine.id;
                
                // Save ODT items
                if (odtItems.length > 0) {
                    const odtData = odtItems.map(item => ({
                        machine_id: machineId,
                        odt_name: item.name,
                        standard_time: item.time
                    }));
                    await db.from('machine_odt').insert(odtData);
                }
                
                // Save Line Stop Mesin items
                if (lineStopMesinItems.length > 0) {
                    const lsmData = lineStopMesinItems.map(item => ({
                        machine_id: machineId,
                        item_name: item
                    }));
                    await db.from('machine_line_stop_mesin').insert(lsmData);
                }
                
                // Save Line Stop Non Mesin items
                if (lineStopNonMesinItems.length > 0) {
                    const lsnmData = lineStopNonMesinItems.map(item => ({
                        machine_id: machineId,
                        item_name: item
                    }));
                    await db.from('machine_line_stop_non_mesin').insert(lsnmData);
                }
                
                // Save Minor Stop items
                if (minorStopItems.length > 0) {
                    const msData = minorStopItems.map(item => ({
                        machine_id: machineId,
                        item_name: item
                    }));
                    await db.from('machine_minor_stop').insert(msData);
                }
                
                return machine;
            } catch (error) {
                console.error('Error saving machine:', error);
                throw error;
            }
        }

        async function updateMachine(machineId, machineData, odtItems, lineStopMesinItems, lineStopNonMesinItems, minorStopItems) {
            try {
                // Update machine
                const { error: machineError } = await db
                    .from('machines')
                    .update(machineData)
                    .eq('id', machineId);
                
                if (machineError) throw machineError;
                
                // Delete existing related data
                await Promise.all([
                    db.from('machine_odt').delete().eq('machine_id', machineId),
                    db.from('machine_line_stop_mesin').delete().eq('machine_id', machineId),
                    db.from('machine_line_stop_non_mesin').delete().eq('machine_id', machineId),
                    db.from('machine_minor_stop').delete().eq('machine_id', machineId)
                ]);
                
                // Insert new data
                if (odtItems.length > 0) {
                    const odtData = odtItems.map(item => ({
                        machine_id: machineId,
                        odt_name: item.name,
                        standard_time: item.time
                    }));
                    await db.from('machine_odt').insert(odtData);
                }
                
                if (lineStopMesin.length > 0) {
                    const lsmData = lineStopMesinItems.map(item => ({
                        machine_id: machineId,
                        item_name: item
                    }));
                    await db.from('machine_line_stop_mesin').insert(lsmData);
                }
                
                if (lineStopNonMesinItems.length > 0) {
                    const lsnmData = lineStopNonMesinItems.map(item => ({
                        machine_id: machineId,
                        item_name: item
                    }));
                    await db.from('machine_line_stop_non_mesin').insert(lsnmData);
                }
                
                if (minorStopItems.length > 0) {
                    const msData = minorStopItems.map(item => ({
                        machine_id: machineId,
                        item_name: item
                    }));
                    await db.from('machine_minor_stop').insert(msData);
                }
                
                return true;
            } catch (error) {
                console.error('Error updating machine:', error);
                throw error;
            }
        }

        async function deleteMachine(machineId) {
            try {
                const { error } = await db
                    .from('machines')
                    .update({ is_deleted: true })
                    .eq('id', machineId);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error deleting machine:', error);
                throw error;
            }
        }

        async function saveOEERecord(recordData) {
            try {
                // Convert complex objects to JSON strings for Supabase
                const cleanedData = {
                    ...recordData,
                    odt_data: JSON.stringify(recordData.odt_data || []),
                    line_stop_mesin_data: JSON.stringify(recordData.line_stop_mesin_data || []),
                    line_stop_non_mesin_data: JSON.stringify(recordData.line_stop_non_mesin_data || []),
                    minor_stop_data: JSON.stringify(recordData.minor_stop_data || [])
                };
                
                const { data, error } = await db
                    .from('oee_records')
                    .insert([cleanedData])
                    .select()
                    .single();
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                return data;
            } catch (error) {
                console.error('Error saving OEE record:', error);
                throw error;
            }
        }

        // =============================================
        // CALCULATION FUNCTIONS
        // =============================================
        function calculateOEE(formData) {
            const shiftMinutes = SHIFTS[formData.shift]?.minutes || 0;
            const targetPerMinute = formData.targetPerMinute || 0;
            
            if (!shiftMinutes || !targetPerMinute) {
                return {
                    availabilityActual: 0,
                    availability365: 0,
                    performance: 0,
                    quality: 0,
                    oeeActual: 0,
                    oee365: 0,
                    totalODT: 0,
                    totalLineStopMesin: 0,
                    totalLineStopNonMesin: 0,
                    odtExceeds: [],
                    remainingTime: 0,
                    shiftMinutes: 0
                };
            }
            
            // Calculate ODT with exceed logic
            let totalODT = 0;
            let odtExceeds = [];
            
            if (formData.odtData) {
                formData.odtData.forEach(odt => {
                    if (odt.checked) {
                        const actualTime = parseFloat(odt.actualTime || 0);
                        const standardTime = parseFloat(odt.standardTime || 0);
                        
                        if (actualTime <= standardTime) {
                            totalODT += actualTime;
                        } else {
                            totalODT += standardTime;
                            const exceed = actualTime - standardTime;
                            odtExceeds.push({
                                item: `ODT Exceed - ${odt.name}`,
                                duration: exceed,
                                action: 'Auto-generated from ODT exceed'
                            });
                        }
                    }
                });
            }
            
            // Calculate total Line Stop Mesin
            let totalLineStopMesin = 0;
            if (formData.lineStopMesinData) {
                formData.lineStopMesinData.forEach(ls => {
                    totalLineStopMesin += parseFloat(ls.duration || 0);
                });
            }
            
            // Calculate total Line Stop Non Mesin (including ODT exceeds)
            let totalLineStopNonMesin = 0;
            if (formData.lineStopNonMesinData) {
                formData.lineStopNonMesinData.forEach(ls => {
                    totalLineStopNonMesin += parseFloat(ls.duration || 0);
                });
            }
            
            // Add ODT exceeds to Line Stop Non Mesin
            odtExceeds.forEach(exceed => {
                totalLineStopNonMesin += exceed.duration;
            });
            
            // Availability Actual: (jam kerja - odt - (line stop mesin + line stop non mesin))/(jam kerja - odt)
            const availabilityActual = shiftMinutes - totalODT > 0 
                ? ((shiftMinutes - totalODT - (totalLineStopMesin + totalLineStopNonMesin)) / (shiftMinutes - totalODT)) * 100 
                : 0;
            
            // Availability 365: (jam kerja - odt - (line stop mesin + line stop non mesin))/jam kerja
            const availability365 = shiftMinutes > 0 
                ? ((shiftMinutes - totalODT - (totalLineStopMesin + totalLineStopNonMesin)) / shiftMinutes) * 100 
                : 0;
            
            // Performance: Actual Output / (Available Time * Target Per Minute)
            const availableTimeActual = shiftMinutes - totalODT - totalLineStopMesin - totalLineStopNonMesin;
            const idealOutput = availableTimeActual * targetPerMinute;
            const performance = idealOutput > 0 ? (formData.actualOutput / idealOutput) * 100 : 0;
            
            // Quality: (Actual Output - Reject) / Actual Output
            const quality = formData.actualOutput > 0 
                ? ((formData.actualOutput - formData.reject) / formData.actualOutput) * 100 
                : 0;
            
            // OEE Actual
            const oeeActual = (availabilityActual * performance * quality) / 10000;
            
            // OEE 365
            const oee365 = (availability365 * performance * quality) / 10000;
            
            return {
                availabilityActual: Math.max(0, Math.min(100, availabilityActual || 0)),
                availability365: Math.max(0, Math.min(100, availability365 || 0)),
                performance: Math.max(0, Math.min(100, performance || 0)),
                quality: Math.max(0, Math.min(100, quality || 0)),
                oeeActual: Math.max(0, Math.min(100, oeeActual || 0)),
                oee365: Math.max(0, Math.min(100, oee365 || 0)),
                totalODT,
                totalLineStopMesin,
                totalLineStopNonMesin,
                odtExceeds,
                remainingTime: availableTimeActual,
                shiftMinutes
            };
        }

        // =============================================
        // RENDERING FUNCTIONS
        // =============================================
        function renderApp() {
            const app = document.getElementById('app-wrapper');
            const config = defaultConfig;
            
            const header = `
                <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div class="container-main" style="max-width: 1400px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <h1 style="color: white; font-size: 28px; font-weight: 900; margin-bottom: 4px;">${config.system_title}</h1>
                                <p style="color: rgba(255,255,255,0.9); font-size: 14px;">${config.company_name}</p>
                            </div>
                            <div style="text-align: right;">
                                <p style="color: white; font-size: 14px; font-weight: 600;">${new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} - ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</p>
                                <p style="color: rgba(255,255,255,0.8); font-size: 12px;">‚úÖ Connected</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const nav = `
                <div class="container-main">
                    <div class="nav-tabs">
                        <button class="nav-tab ${currentPage === 'dashboard' ? 'active' : ''}" onclick="navigateTo('dashboard')">üìä Dashboard</button>
                        <button class="nav-tab ${currentPage === 'input' ? 'active' : ''}" onclick="navigateTo('input')">‚úèÔ∏è Input OEE</button>
                        <button class="nav-tab ${currentPage === 'management' ? 'active' : ''}" onclick="navigateTo('management')">‚öôÔ∏è Management</button>
                        <button class="nav-tab ${currentPage === 'export' ? 'active' : ''}" onclick="navigateTo('export')">üì• Export</button>
                    </div>
                </div>
            `;
            
            let content = '';
            
            if (currentPage === 'dashboard') {
                content = renderDashboard();
            } else if (currentPage === 'input') {
                content = renderInputPage();
            } else if (currentPage === 'management') {
                content = isManagementUnlocked ? renderManagementPage() : renderManagementLogin();
            } else if (currentPage === 'export') {
                content = renderExportPage();
            }
            
            app.innerHTML = header + nav + content;
            
            if (currentPage === 'dashboard') {
                setTimeout(renderCharts, 100);
            }
        }

        function renderDashboard() {
            const filtered = getFilteredRecords();
            
            // Calculate averages
            const avgOEEActual = filtered.length > 0 ? filtered.reduce((sum, r) => sum + (r.oee_actual || 0), 0) / filtered.length : 0;
            const avgOEE365 = filtered.length > 0 ? filtered.reduce((sum, r) => sum + (r.oee_365 || 0), 0) / filtered.length : 0;
            const totalOutput = filtered.reduce((sum, r) => sum + (r.actual_output || 0), 0);
            
            // Get unique PICs and machines
            const uniquePICs = [...new Set(allOEERecords.map(r => r.pic).filter(Boolean))];
            const uniqueMachines = [...new Set(allOEERecords.map(r => r.machine_name).filter(Boolean))];
            
            // Format dates for display
            const startDateDisplay = new Date(filters.startDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long' });
            const endDateDisplay = new Date(filters.endDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            
            return `
                <div class="container-main">
                    <!-- Filters -->
                    <div class="card">
                        <div class="card-header">üîç Filter Data</div>
                        <div class="filter-section">
                            <div>
                                <label class="label">Start Date (Awal Bulan)</label>
                                <input type="date" id="filter-start-date" value="${filters.startDate}" class="input-field" onchange="updateFilter('startDate', this.value)">
                            </div>
                            <div>
                                <label class="label">End Date (Akhir Bulan)</label>
                                <input type="date" id="filter-end-date" value="${filters.endDate}" class="input-field" onchange="updateFilter('endDate', this.value)">
                            </div>
                            <div>
                                <label class="label">Shift</label>
                                <select id="filter-shift" class="input-field" onchange="updateFilter('shift', this.value)">
                                    <option value="all">All Shifts</option>
                                    ${Object.keys(SHIFTS).map(s => `<option value="${s}" ${filters.shift === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="label">Machine</label>
                                <select id="filter-machine" class="input-field" onchange="updateFilter('machine', this.value)">
                                    <option value="all">All Machines</option>
                                    ${uniqueMachines.map(m => `<option value="${m}" ${filters.machine === m ? 'selected' : ''}>${m}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="label">PIC / Operator</label>
                                <select id="filter-pic" class="input-field" onchange="updateFilter('pic', this.value)">
                                    <option value="all">All Operators</option>
                                    ${uniquePICs.map(p => `<option value="${p}" ${filters.pic === p ? 'selected' : ''}>${p}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: rgba(102, 125, 234, 0.1); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span style="color: var(--accent-primary); font-weight: 600;">üìÖ</span>
                                <span style="color: var(--text-primary); font-size: 14px; word-break: break-word;">
                                    Menampilkan data dari <strong>${startDateDisplay}</strong> hingga <strong>${endDateDisplay}</strong>
                                    <span style="color: var(--text-secondary); font-size: 13px; display: block; margin-top: 4px;">
                                        Filter otomatis diatur ke periode bulan berjalan
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scorecards -->
                    <div class="card">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px;">
                            <div class="scorecard ${avgOEEActual >= 88 ? 'good' : 'bad'}">
                                <div class="scorecard-label">Average OEE Actual</div>
                                <div class="scorecard-value">${avgOEEActual.toFixed(1)}%</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Target: 88%</div>
                            </div>
                            <div class="scorecard ${avgOEE365 >= 55 ? 'good' : 'bad'}">
                                <div class="scorecard-label">Average OEE 365</div>
                                <div class="scorecard-value">${avgOEE365.toFixed(1)}%</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Target: 55%</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
                            <div class="scorecard">
                                <div class="scorecard-label">Total Output</div>
                                <div class="scorecard-value" style="color: var(--accent-primary);">${totalOutput.toLocaleString('id-ID')}</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${filtered.length} Records</div>
                            </div>
                            <div class="scorecard">
                                <div class="scorecard-label">Jumlah Mesin Aktif</div>
                                <div class="scorecard-value" style="color: var(--success);">${allMachines.length}</div>
                                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Total Machines</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row 1 -->
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">üìà OEE Trend (Oldest to Newest)</div>
                            <div class="chart-container">
                                <canvas id="chart-trend"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">üéØ OEE Actual per Machine</div>
                            <div class="chart-container">
                                <canvas id="chart-per-machine"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row 2 -->
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">üìä A-P-Q-A365 Breakdown</div>
                            <div class="chart-container">
                                <canvas id="chart-apq"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">‚è±Ô∏è ODT Top 10 (menit)</div>
                            <div class="chart-container-horizontal">
                                <div id="odt-total-badge" class="chart-total-badge"></div>
                                <canvas id="chart-odt"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row 3 -->
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">üîß Line Stop Mesin Top 10 (menit)</div>
                            <div class="chart-container-horizontal">
                                <div id="lsm-total-badge" class="chart-total-badge"></div>
                                <canvas id="chart-ls-mesin"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">‚ö†Ô∏è Line Stop Non Mesin Top 10 (menit)</div>
                            <div class="chart-container-horizontal">
                                <div id="lsnm-total-badge" class="chart-total-badge"></div>
                                <canvas id="chart-ls-non-mesin"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Minor Stop Chart -->
                    <div class="card">
                        <div class="card-header">‚è∏Ô∏è Minor Stop Top 10 (kali)</div>
                        <div class="chart-container-horizontal">
                            <div id="ms-total-badge" class="chart-total-badge"></div>
                            <canvas id="chart-minor-stop"></canvas>
                        </div>
                    </div>
                    
                    <!-- Operator Performance -->
                    <div class="card">
                        <div class="card-header">üë®‚Äçüîß Operator Performance</div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="nowrap">PIC</th>
                                        <th class="nowrap">Avg OEE Actual</th>
                                        <th class="nowrap">Total Output</th>
                                        <th class="nowrap">Target Output</th>
                                        <th class="nowrap">Achievement</th>
                                        <th class="nowrap">Records</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${generateOperatorPerformance(filtered)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- OEE History -->
                    <div class="card">
                        <div class="card-header">üìã OEE History</div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="nowrap">Date</th>
                                        <th class="nowrap">Shift</th>
                                        <th class="nowrap">Machine</th>
                                        <th class="nowrap">PIC</th>
                                        <th class="nowrap">Product</th>
                                        <th class="nowrap">Batch</th>
                                        <th class="nowrap">Output</th>
                                        <th class="nowrap">Reject</th>
                                        <th class="nowrap">A%</th>
                                        <th class="nowrap">P%</th>
                                        <th class="nowrap">Q%</th>
                                        <th class="nowrap">OEE Actual</th>
                                        <th class="nowrap">OEE 365</th>
                                        <th class="nowrap">WR Number</th>
                                        <th class="nowrap">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${generateOEEHistoryRows(filtered)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateOperatorPerformance(records) {
            const picStats = {};
            
            records.forEach(r => {
                if (!r.pic) return;
                
                if (!picStats[r.pic]) {
                    picStats[r.pic] = {
                        totalOEE: 0,
                        totalOutput: 0,
                        totalTargetOutput: 0,
                        count: 0
                    };
                }
                picStats[r.pic].totalOEE += r.oee_actual || 0;
                picStats[r.pic].totalOutput += r.actual_output || 0;
                
                // Calculate target output for this record
                const shiftMinutes = SHIFTS[r.shift]?.minutes || 0;
                const machine = allMachines.find(m => m.id === r.machine_id);
                const targetPerMinute = machine?.target_per_minute || 0;
                
                // Calculate ODT, Line Stop Mesin, Line Stop Non Mesin
                let totalODT = 0;
                try {
                    const odtData = typeof r.odt_data === 'string' ? JSON.parse(r.odt_data) : (r.odt_data || []);
                    odtData.forEach(odt => {
                        if (odt.checked) {
                            const actualTime = parseFloat(odt.actualTime || 0);
                            const standardTime = parseFloat(odt.standardTime || 0);
                            totalODT += Math.min(actualTime, standardTime);
                        }
                    });
                } catch (e) {
                    console.error('Error parsing ODT data:', e);
                }
                
                let totalLSM = 0;
                try {
                    const lsmData = typeof r.line_stop_mesin_data === 'string' ? JSON.parse(r.line_stop_mesin_data) : (r.line_stop_mesin_data || []);
                    lsmData.forEach(ls => {
                        totalLSM += parseFloat(ls.duration || 0);
                    });
                } catch (e) {
                    console.error('Error parsing LSM data:', e);
                }
                
                let totalLSNM = 0;
                try {
                    const lsnmData = typeof r.line_stop_non_mesin_data === 'string' ? JSON.parse(r.line_stop_non_mesin_data) : (r.line_stop_non_mesin_data || []);
                    lsnmData.forEach(ls => {
                        totalLSNM += parseFloat(ls.duration || 0);
                    });
                } catch (e) {
                    console.error('Error parsing LSNM data:', e);
                }
                
                const availableTime = shiftMinutes - totalODT - totalLSM - totalLSNM;
                const targetOutput = availableTime * targetPerMinute;
                
                picStats[r.pic].totalTargetOutput += targetOutput;
                picStats[r.pic].count += 1;
            });
            
            // Sort by achievement (descending)
            const sorted = Object.entries(picStats)
                .map(([pic, stats]) => ({
                    pic,
                    avgOEE: stats.totalOEE / stats.count,
                    totalOutput: stats.totalOutput,
                    totalTargetOutput: stats.totalTargetOutput,
                    achievement: stats.totalTargetOutput > 0 ? (stats.totalOutput / stats.totalTargetOutput) * 100 : 0,
                    count: stats.count
                }))
                .sort((a, b) => b.achievement - a.achievement);
            
            return sorted.map(s => `
                <tr>
                    <td class="wrap-text"><strong>${s.pic}</strong></td>
                    <td class="${s.avgOEE >= 88 ? 'status-good' : 'status-bad'} wrap-text">${s.avgOEE.toFixed(1)}%</td>
                    <td class="wrap-text">${s.totalOutput.toLocaleString('id-ID')}</td>
                    <td class="wrap-text">${Math.round(s.totalTargetOutput).toLocaleString('id-ID')}</td>
                    <td class="${s.achievement >= 100 ? 'status-good' : 'status-bad'} wrap-text">${s.achievement.toFixed(1)}%</td>
                    <td class="wrap-text">${s.count}</td>
                </tr>
            `).join('');
        }

        function generateOEEHistoryRows(records) {
            if (records.length === 0) {
                return '<tr><td colspan="15" style="text-align: center; color: var(--text-secondary); padding: 40px;">No records found for this period</td></tr>';
            }
            
            return records.map(r => {
                // Extract WR numbers from Line Stop Mesin data
                let wrNumbers = [];
                try {
                    if (r.line_stop_mesin_data) {
                        const lsmData = typeof r.line_stop_mesin_data === 'string' ? JSON.parse(r.line_stop_mesin_data) : r.line_stop_mesin_data;
                        lsmData.forEach(ls => {
                            if (ls.wr) {
                                wrNumbers.push(`${ls.item}: ${ls.wr}`);
                            }
                        });
                    }
                } catch (e) {
                    console.error('Error parsing WR numbers:', e);
                }
                
                const wrDisplay = wrNumbers.length > 0 
                    ? `<div style="max-width: 150px; font-size: 11px; line-height: 1.3;">${wrNumbers.map(wr => `<div style="padding: 2px 0;">${wr}</div>`).join('')}</div>`
                    : '-';
                
                return `
                    <tr>
                        <td class="wrap-text">${r.date ? new Date(r.date).toLocaleDateString('id-ID') : '-'}</td>
                        <td class="wrap-text">${r.shift || '-'}</td>
                        <td class="wrap-text"><strong>${r.machine_name || '-'}</strong></td>
                        <td class="wrap-text">${r.pic || '-'}</td>
                        <td class="wrap-text">${r.product_code || '-'}</td>
                        <td class="wrap-text">${r.batch_number || '-'}</td>
                        <td class="wrap-text">${(r.actual_output || 0).toLocaleString('id-ID')}</td>
                        <td class="wrap-text">${r.reject || 0}</td>
                        <td class="${(r.availability_actual || 0) >= 91 ? 'status-good' : 'status-bad'} wrap-text">${(r.availability_actual || 0).toFixed(1)}%</td>
                        <td class="${(r.performance || 0) >= 98 ? 'status-good' : 'status-bad'} wrap-text">${(r.performance || 0).toFixed(1)}%</td>
                        <td class="${(r.quality || 0) >= 99 ? 'status-good' : 'status-bad'} wrap-text">${(r.quality || 0).toFixed(1)}%</td>
                        <td class="${(r.oee_actual || 0) >= 88 ? 'status-good' : 'status-bad'} wrap-text">${(r.oee_actual || 0).toFixed(1)}%</td>
                        <td class="${(r.oee_365 || 0) >= 55 ? 'status-good' : 'status-bad'} wrap-text">${(r.oee_365 || 0).toFixed(1)}%</td>
                        <td class="wr-cell wrap-text">${wrDisplay}</td>
                        <td class="notes-cell wrap-text" title="${r.notes || ''}">${r.notes || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderInputPage() {
            if (allMachines.length === 0) {
                return `
                    <div class="container-main">
                        <div class="card" style="text-align: center; padding: 60px 24px;">
                            <h3 style="color: var(--danger); font-size: 24px; margin-bottom: 16px;">‚ö†Ô∏è No Machines Configured</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 24px;">Please add machines in Management page first</p>
                            <button class="btn btn-primary" onclick="navigateTo('management')">Go to Management</button>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="container-main">
                    <div class="card">
                        <div class="card-header">‚úèÔ∏è Input OEE Data</div>
                        
                        <!-- Basic Info -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div>
                                <label class="label">Tanggal *</label>
                                <input type="date" id="input-date" value="${new Date().toISOString().split('T')[0]}" class="input-field">
                            </div>
                            <div>
                                <label class="label">Shift *</label>
                                <select id="input-shift" class="input-field" onchange="updateCalculations()">
                                    <option value="">Select Shift</option>
                                    ${Object.keys(SHIFTS).map(s => `<option value="${s}">${s} (${SHIFTS[s].start} - ${SHIFTS[s].end})</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="label">Machine *</label>
                                <select id="input-machine" class="input-field" onchange="loadMachineData()">
                                    <option value="">Select Machine</option>
                                    ${allMachines.map(m => `<option value="${m.id}">${m.machine_name} - ${m.area}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="label">PIC / Operator *</label>
                                <input type="text" id="input-pic" class="input-field" style="text-transform: uppercase;">
                            </div>
                            <div>
                                <label class="label">Kode Produk *</label>
                                <input type="text" id="input-product" class="input-field" style="text-transform: uppercase;">
                            </div>
                            <div>
                                <label class="label">Nomor Batch *</label>
                                <input type="text" id="input-batch" class="input-field" style="text-transform: uppercase;">
                            </div>
                        </div>
                        
                        <!-- ODT Section -->
                        <div id="odt-section" style="margin-bottom: 24px; display: none;">
                            <h4 style="font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">‚è±Ô∏è ODT (Operational Downtime)</h4>
                            <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                                üí° <strong>ODT Logic:</strong> Jika actual time > standard time, maka selisihnya otomatis masuk ke Line Stop Non Mesin
                            </p>
                            <div id="odt-list"></div>
                        </div>
                        
                        <!-- Line Stop Mesin Section -->
                        <div id="line-stop-mesin-section" style="margin-bottom: 24px; display: none;">
                            <h4 style="font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">üîß Line Stop Mesin</h4>
                            <div id="line-stop-mesin-list"></div>
                            <button type="button" class="btn btn-secondary" style="margin-top: 12px;" onclick="addCustomLineStopMesin()">‚ûï Add Custom Line Stop Mesin</button>
                            <div id="custom-line-stop-mesin-container"></div>
                        </div>
                        
                        <!-- Line Stop Non Mesin Section -->
                        <div id="line-stop-non-mesin-section" style="margin-bottom: 24px; display: none;">
                            <h4 style="font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">‚ö†Ô∏è Line Stop Non Mesin</h4>
                            <div id="line-stop-non-mesin-list"></div>
                            <button type="button" class="btn btn-secondary" style="margin-top: 12px;" onclick="addCustomLineStopNonMesin()">‚ûï Add Custom Line Stop Non Mesin</button>
                            <div id="custom-line-stop-non-mesin-container"></div>
                            
                            <!-- ODT Exceed List -->
                            <div id="odt-exceed-list" style="margin-top: 16px;"></div>
                        </div>
                        
                        <!-- Minor Stop Section -->
                        <div id="minor-stop-section" style="margin-bottom: 24px; display: none;">
                            <h4 style="font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">‚è∏Ô∏è Minor Stop</h4>
                            <div id="minor-stop-list"></div>
                            <button type="button" class="btn btn-secondary" style="margin-top: 12px;" onclick="addCustomMinorStop()">‚ûï Add Custom Minor Stop</button>
                            <div id="custom-minor-stop-container"></div>
                        </div>
                        
                        <!-- Output -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div>
                                <label class="label">Actual Output *</label>
                                <input type="number" id="input-output" min="0" class="input-field" oninput="updateCalculations()">
                            </div>
                            <div>
                                <label class="label">Reject</label>
                                <input type="number" id="input-reject" value="0" min="0" class="input-field" oninput="updateCalculations()">
                            </div>
                        </div>
                        
                        <!-- Target Recommendation -->
                        <div id="target-recommendation" class="target-box">
                            <h4 style="font-weight: 800; margin-bottom: 12px; color: var(--accent-primary); font-size: 18px; display: flex; align-items: center; gap: 8px;">
                                üéØ Target Output Recommendation
                            </h4>
                            <div id="target-text" style="font-size: 16px; color: var(--text-primary); font-weight: 600; padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px;">
                                <span style="color: var(--text-secondary);">Select Machine and Shift to see target</span>
                            </div>
                            <div id="target-details" style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                                Target akan otomatis dihitung berdasarkan available time (shift - ODT - line stops) √ó target per minute
                            </div>
                        </div>
                        
                        <!-- Calculated Results -->
                        <div id="calculated-results" style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 24px; display: none;">
                            <h4 style="font-weight: 700; margin-bottom: 16px; color: var(--text-primary);">üßÆ Calculated Results</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Availability Actual</div>
                                    <div id="calc-a-actual" style="font-size: 24px; font-weight: 700;">0%</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Availability 365</div>
                                    <div id="calc-a-365" style="font-size: 24px; font-weight: 700;">0%</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Performance</div>
                                    <div id="calc-p" style="font-size: 24px; font-weight: 700;">0%</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Quality</div>
                                    <div id="calc-q" style="font-size: 24px; font-weight: 700;">0%</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">OEE Actual</div>
                                    <div id="calc-oee-actual" style="font-size: 24px; font-weight: 700;">0%</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">OEE 365</div>
                                    <div id="calc-oee-365" style="font-size: 24px; font-weight: 700;">0%</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes -->
                        <div style="margin-bottom: 24px;">
                            <label class="label">Catatan</label>
                            <textarea id="input-notes" rows="3" class="input-field" placeholder="Additional notes (optional)"></textarea>
                        </div>
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="saveOEEData()" style="flex: 1; min-width: 200px;">üíæ Simpan Data OEE</button>
                            <button class="btn btn-secondary" onclick="resetInputForm()" style="flex: 1; min-width: 200px;">üîÑ Reset Form</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderManagementLogin() {
            return `
                <div class="container-main">
                    <div class="card" style="max-width: 500px; margin: 60px auto; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üîí</div>
                        <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Management Access</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 24px;">Enter password to access machine management</p>
                        <input type="password" id="mgmt-password" class="input-field" placeholder="Enter password" style="margin-bottom: 16px;">
                        <button class="btn btn-primary" style="width: 100%;" onclick="unlockManagement()">üîì Unlock</button>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-top: 16px;">Default password hubungi administrator</p>
                    </div>
                </div>
            `;
        }

        function renderManagementPage() {
            return `
                <div class="container-main">
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                            <div class="card-header" style="margin: 0;">‚öôÔ∏è Machine Management</div>
                            <button class="btn btn-primary" onclick="openAddMachineModal()">‚ûï Add Machine</button>
                        </div>
                        
                        ${allMachines.length > 0 ? `
                            <div class="table-wrapper">
                                <table>
                                    <thead>
                                        <tr>
                                            <th class="nowrap">Machine Name</th>
                                            <th class="nowrap">Area</th>
                                            <th class="nowrap">Target/Min</th>
                                            <th class="nowrap">PIC</th>
                                            <th class="nowrap">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allMachines.map(m => `
                                            <tr>
                                                <td class="wrap-text"><strong>${m.machine_name}</strong></td>
                                                <td class="wrap-text"><span class="badge ${m.area === 'Injeksi' ? 'badge-success' : 'badge-danger'}">${m.area}</span></td>
                                                <td class="wrap-text">${m.target_per_minute || 0}/min</td>
                                                <td class="wrap-text">${m.pic || '-'}</td>
                                                <td class="wrap-text">
                                                    <button class="btn btn-secondary" style="padding: 6px 12px; margin-right: 8px;" onclick="editMachine('${m.id}')">Edit</button>
                                                    <button class="btn btn-danger" style="padding: 6px 12px;" onclick="confirmDeleteMachine('${m.id}', '${m.machine_name}')">Delete</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 60px 24px; color: var(--text-secondary);">
                                <p style="font-size: 16px; margin-bottom: 16px;">No machines configured yet</p>
                                <p>Click "Add Machine" to get started</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderExportPage() {
            return `
                <div class="container-main">
                    <div class="card" style="max-width: 600px; margin: 0 auto;">
                        <div class="card-header">üì• Export Data</div>
                        
                        <div style="margin-bottom: 24px;">
                            <label class="label">Start Date</label>
                            <input type="date" id="export-start-date" value="${getCurrentMonthStart()}" class="input-field">
                        </div>
                        
                        <div style="margin-bottom: 24px;">
                            <label class="label">End Date</label>
                            <input type="date" id="export-end-date" value="${getCurrentMonthEnd()}" class="input-field">
                        </div>
                        
                        <div style="margin-bottom: 32px;">
                            <label class="label">Export Format</label>
                            <select id="export-format" class="input-field">
                                <option value="excel">Excel (Tab Separated)</option>
                                <option value="pdf">PDF Document</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%;" onclick="exportData()">üì• Download Data</button>
                    </div>
                </div>
            `;
        }

        // =============================================
        // CHART RENDERING
        // =============================================
        function renderCharts() {
            const filtered = getFilteredRecords();
            
            // Destroy existing charts
            Object.values(chartInstances).forEach(chart => {
                try {
                    if (chart && chart.destroy) chart.destroy();
                } catch (e) {
                    console.error('Error destroying chart:', e);
                }
            });
            chartInstances = {};
            
            // Render all charts
            renderTrendChart(filtered);
            renderPerMachineChart(filtered);
            renderAPQChart(filtered);
            renderODTChart(filtered);
            renderLineStopMesinChart(filtered);
            renderLineStopNonMesinChart(filtered);
            renderMinorStopChart(filtered);
        }

        function renderTrendChart(records) {
            const ctx = document.getElementById('chart-trend');
            if (!ctx) return;
            
            try {
                const sorted = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
                const labels = sorted.map(r => {
                    const date = new Date(r.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' });
                    const shift = r.shift ? r.shift.replace('Shift ', 'S').replace('Longshift ', 'LS ') : '';
                    return `${date}\n${shift}`;
                });
                const data = sorted.map(r => r.oee_actual || 0);
                
                if (data.length === 0) return;
                
                const pointColors = data.map(value => value >= 88 ? '#10b981' : '#ef4444');
                
                chartInstances.trend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'OEE Actual',
                            data,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 125, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: pointColors,
                            pointBorderColor: pointColors,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }, {
                            label: 'Target 88%',
                            data: Array(labels.length).fill(88),
                            borderColor: '#10b981',
                            borderDash: [5, 5],
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        const record = sorted[index];
                                        const date = new Date(record.date).toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' });
                                        return `${date} - ${record.shift || ''}`;
                                    },
                                    afterTitle: function(context) {
                                        const index = context[0].dataIndex;
                                        const record = sorted[index];
                                        return `Machine: ${record.machine_name || ''} | PIC: ${record.pic || ''}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100 },
                            x: {
                                ticks: {
                                    font: { size: 10 },
                                    maxRotation: 0,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('Error rendering trend chart:', e);
            }
        }

        function renderPerMachineChart(records) {
            const ctx = document.getElementById('chart-per-machine');
            if (!ctx) return;
            
            try {
                const machineStats = {};
                records.forEach(r => {
                    if (!r.machine_name) return;
                    
                    if (!machineStats[r.machine_name]) {
                        machineStats[r.machine_name] = { total: 0, count: 0 };
                    }
                    machineStats[r.machine_name].total += r.oee_actual || 0;
                    machineStats[r.machine_name].count += 1;
                });
                
                const data = Object.entries(machineStats).map(([name, stats]) => ({
                    name,
                    avg: stats.total / stats.count
                })).sort((a, b) => b.avg - a.avg);
                
                if (data.length === 0) return;
                
                const labels = data.map(d => d.name);
                const values = data.map(d => d.avg);
                const colors = values.map(v => v >= 88 ? '#10b981' : '#ef4444');
                
                chartInstances.perMachine = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Avg OEE Actual',
                            data: values,
                            backgroundColor: colors
                        }, {
                            label: 'Target 88%',
                            data: Array(labels.length).fill(88),
                            type: 'line',
                            borderColor: '#10b981',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true }
                        },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    },
                    plugins: [{
                        id: 'datalabels',
                        afterDatasetsDraw: function(chart) {
                            const { ctx, data, chartArea: { top, bottom, left, right, width, height } } = chart;
                            ctx.save();
                            
                            data.datasets[0].data.forEach((value, index) => {
                                const meta = chart.getDatasetMeta(0);
                                const bar = meta.data[index];
                                
                                if (bar) {
                                    const x = bar.x;
                                    const y = bar.y;
                                    const barWidth = bar.width;
                                    const barHeight = bar.height;
                                    
                                    // Hitung posisi tengah bar
                                    const centerX = x;
                                    const centerY = y + (barHeight / 2);
                                    
                                    // Tampilkan label di tengah bar
                                    ctx.fillStyle = '#ffffff';
                                    ctx.font = 'bold 11px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value.toFixed(1) + '%', centerX, centerY);
                                }
                            });
                            
                            ctx.restore();
                        }
                    }]
                });
            } catch (e) {
                console.error('Error rendering per machine chart:', e);
            }
        }

        function renderAPQChart(records) {
            const ctx = document.getElementById('chart-apq');
            if (!ctx) return;
            
            try {
                const avgA = records.length > 0 ? records.reduce((sum, r) => sum + (r.availability_actual || 0), 0) / records.length : 0;
                const avgP = records.length > 0 ? records.reduce((sum, r) => sum + (r.performance || 0), 0) / records.length : 0;
                const avgQ = records.length > 0 ? records.reduce((sum, r) => sum + (r.quality || 0), 0) / records.length : 0;
                const avgA365 = records.length > 0 ? records.reduce((sum, r) => sum + (r.availability_365 || 0), 0) / records.length : 0;
                
                chartInstances.apq = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Availability', 'Performance', 'Quality', 'Availability 365'],
                        datasets: [{
                            label: 'Average %',
                            data: [avgA, avgP, avgQ, avgA365],
                            backgroundColor: [
                                avgA >= 91 ? '#10b981' : '#ef4444',
                                avgP >= 98 ? '#10b981' : '#ef4444',
                                avgQ >= 99 ? '#10b981' : '#ef4444',
                                '#667eea'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            } 
                        }
                    },
                    plugins: [{
                        id: 'datalabels',
                        afterDatasetsDraw: function(chart) {
                            const { ctx, data, chartArea: { top, bottom, left, right, width, height } } = chart;
                            ctx.save();
                            
                            data.datasets[0].data.forEach((value, index) => {
                                const meta = chart.getDatasetMeta(0);
                                const bar = meta.data[index];
                                
                                if (bar) {
                                    const x = bar.x;
                                    const y = bar.y;
                                    const barWidth = bar.width;
                                    const barHeight = bar.height;
                                    
                                    // Hitung posisi tengah bar
                                    const centerX = x;
                                    const centerY = y + (barHeight / 2);
                                    
                                    // Tampilkan label di tengah bar
                                    ctx.fillStyle = '#ffffff';
                                    ctx.font = 'bold 12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value.toFixed(1) + '%', centerX, centerY);
                                }
                            });
                            
                            ctx.restore();
                        }
                    }]
                });
            } catch (e) {
                console.error('Error rendering APQ chart:', e);
            }
        }

        function renderODTChart(records) {
            const ctx = document.getElementById('chart-odt');
            if (!ctx) return;
            
            try {
                const odtStats = {};
                let totalMinutes = 0;
                records.forEach(r => {
                    try {
                        if (r.odt_data) {
                            const odtData = typeof r.odt_data === 'string' ? JSON.parse(r.odt_data) : r.odt_data;
                            odtData.forEach(odt => {
                                if (odt.checked) {
                                    const actualTime = parseFloat(odt.actualTime || 0);
                                    const standardTime = parseFloat(odt.standardTime || 0);
                                    const time = Math.min(actualTime, standardTime);
                                    if (odt.name) {
                                        odtStats[odt.name] = (odtStats[odt.name] || 0) + time;
                                        totalMinutes += time;
                                    }
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing ODT data for chart:', e);
                    }
                });
                
                const sorted = Object.entries(odtStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                if (sorted.length === 0) return;
                
                // Update total badge - DIPINDAH POSISINYA
                const totalBadge = document.getElementById('odt-total-badge');
                if (totalBadge) {
                    totalBadge.innerHTML = `üìä Total: ${totalMinutes.toFixed(0)} menit`;
                }
                
                const labels = sorted.map(s => {
                    const name = s[0];
                    return name.length > 25 ? name.substring(0, 22) + '...' : name;
                });
                const values = sorted.map(s => s[1]);
                
                chartInstances.odt = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Total Minutes',
                            data: values,
                            backgroundColor: '#f59e0b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const index = tooltipItems[0].dataIndex;
                                        return sorted[index][0];
                                    },
                                    label: function(context) {
                                        return `Duration: ${context.raw.toFixed(1)} minutes`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    autoSkip: false,
                                    maxRotation: 0
                                },
                                afterFit: function(scale) {
                                    scale.width = 180;
                                }
                            }
                        },
                        layout: {
                            padding: {
                                left: 10,
                                right: 60,
                                top: 40, // DITAMBAHKAN PADDING ATAS UNTUK BADGE
                                bottom: 10
                            }
                        }
                    },
                    plugins: [{
                        id: 'datalabels',
                        afterDatasetsDraw: function(chart) {
                            const { ctx, data, chartArea: { top, bottom, left, right, width, height } } = chart;
                            ctx.save();
                            
                            data.datasets[0].data.forEach((value, index) => {
                                const meta = chart.getDatasetMeta(0);
                                const bar = meta.data[index];
                                
                                if (bar) {
                                    const x = bar.x;
                                    const y = bar.y;
                                    const barWidth = bar.width;
                                    const barHeight = bar.height;
                                    
                                    // Hitung posisi di sebelah kanan bar (horizontal chart)
                                    const labelX = x + 5;
                                    const labelY = y;
                                    
                                    // Tampilkan label di sebelah kanan bar (tanpa satuan)
                                    ctx.fillStyle = '#333333';
                                    ctx.font = 'bold 11px Arial';
                                    ctx.textAlign = 'left';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value.toFixed(0), labelX, labelY);
                                }
                            });
                            
                            ctx.restore();
                        }
                    }]
                });
            } catch (e) {
                console.error('Error rendering ODT chart:', e);
            }
        }

        function renderLineStopMesinChart(records) {
            const ctx = document.getElementById('chart-ls-mesin');
            if (!ctx) return;
            
            try {
                const lsStats = {};
                let totalMinutes = 0;
                records.forEach(r => {
                    try {
                        if (r.line_stop_mesin_data) {
                            const lsData = typeof r.line_stop_mesin_data === 'string' ? JSON.parse(r.line_stop_mesin_data) : r.line_stop_mesin_data;
                            lsData.forEach(ls => {
                                const duration = parseFloat(ls.duration || 0);
                                if (ls.item) {
                                    lsStats[ls.item] = (lsStats[ls.item] || 0) + duration;
                                    totalMinutes += duration;
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing LSM data for chart:', e);
                    }
                });
                
                const sorted = Object.entries(lsStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                if (sorted.length === 0) return;
                
                // Update total badge - DIPINDAH POSISINYA
                const totalBadge = document.getElementById('lsm-total-badge');
                if (totalBadge) {
                    totalBadge.innerHTML = `üîß Total: ${totalMinutes.toFixed(0)} menit`;
                }
                
                const labels = sorted.map(s => {
                    const name = s[0];
                    return name.length > 25 ? name.substring(0, 22) + '...' : name;
                });
                const values = sorted.map(s => s[1]);
                
                chartInstances.lsMesin = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Total Minutes',
                            data: values,
                            backgroundColor: '#ef4444'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const index = tooltipItems[0].dataIndex;
                                        return sorted[index][0];
                                    },
                                    label: function(context) {
                                        return `Duration: ${context.raw.toFixed(1)} minutes`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    autoSkip: false,
                                    maxRotation: 0
                                },
                                afterFit: function(scale) {
                                    scale.width = 180;
                                }
                            }
                        },
                        layout: {
                            padding: {
                                left: 10,
                                right: 60,
                                top: 40, // DITAMBAHKAN PADDING ATAS UNTUK BADGE
                                bottom: 10
                            }
                        }
                    },
                    plugins: [{
                        id: 'datalabels',
                        afterDatasetsDraw: function(chart) {
                            const { ctx, data, chartArea: { top, bottom, left, right, width, height } } = chart;
                            ctx.save();
                            
                            data.datasets[0].data.forEach((value, index) => {
                                const meta = chart.getDatasetMeta(0);
                                const bar = meta.data[index];
                                
                                if (bar) {
                                    const x = bar.x;
                                    const y = bar.y;
                                    const barWidth = bar.width;
                                    const barHeight = bar.height;
                                    
                                    // Hitung posisi di sebelah kanan bar
                                    const labelX = x + 5;
                                    const labelY = y;
                                    
                                    // Tampilkan label di sebelah kanan bar (tanpa satuan)
                                    ctx.fillStyle = '#333333';
                                    ctx.font = 'bold 11px Arial';
                                    ctx.textAlign = 'left';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value.toFixed(0), labelX, labelY);
                                }
                            });
                            
                            ctx.restore();
                        }
                    }]
                });
            } catch (e) {
                console.error('Error rendering LSM chart:', e);
            }
        }

        function renderLineStopNonMesinChart(records) {
            const ctx = document.getElementById('chart-ls-non-mesin');
            if (!ctx) return;
            
            try {
                const lsStats = {};
                let totalMinutes = 0;
                records.forEach(r => {
                    try {
                        if (r.line_stop_non_mesin_data) {
                            const lsData = typeof r.line_stop_non_mesin_data === 'string' ? JSON.parse(r.line_stop_non_mesin_data) : r.line_stop_non_mesin_data;
                            lsData.forEach(ls => {
                                const duration = parseFloat(ls.duration || 0);
                                if (ls.item) {
                                    lsStats[ls.item] = (lsStats[ls.item] || 0) + duration;
                                    totalMinutes += duration;
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing LSNM data for chart:', e);
                    }
                });
                
                const sorted = Object.entries(lsStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                if (sorted.length === 0) return;
                
                // Update total badge - DIPINDAH POSISINYA
                const totalBadge = document.getElementById('lsnm-total-badge');
                if (totalBadge) {
                    totalBadge.innerHTML = `‚ö†Ô∏è Total: ${totalMinutes.toFixed(0)} menit`;
                }
                
                const labels = sorted.map(s => {
                    const name = s[0];
                    return name.length > 25 ? name.substring(0, 22) + '...' : name;
                });
                const values = sorted.map(s => s[1]);
                
                chartInstances.lsNonMesin = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Total Minutes',
                            data: values,
                            backgroundColor: '#f59e0b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const index = tooltipItems[0].dataIndex;
                                        return sorted[index][0];
                                    },
                                    label: function(context) {
                                        return `Duration: ${context.raw.toFixed(1)} minutes`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    autoSkip: false,
                                    maxRotation: 0
                                },
                                afterFit: function(scale) {
                                    scale.width = 180;
                                }
                            }
                        },
                        layout: {
                            padding: {
                                left: 10,
                                right: 60,
                                top: 40, // DITAMBAHKAN PADDING ATAS UNTUK BADGE
                                bottom: 10
                            }
                        }
                    },
                    plugins: [{
                        id: 'datalabels',
                        afterDatasetsDraw: function(chart) {
                            const { ctx, data, chartArea: { top, bottom, left, right, width, height } } = chart;
                            ctx.save();
                            
                            data.datasets[0].data.forEach((value, index) => {
                                const meta = chart.getDatasetMeta(0);
                                const bar = meta.data[index];
                                
                                if (bar) {
                                    const x = bar.x;
                                    const y = bar.y;
                                    const barWidth = bar.width;
                                    const barHeight = bar.height;
                                    
                                    // Hitung posisi di sebelah kanan bar
                                    const labelX = x + 5;
                                    const labelY = y;
                                    
                                    // Tampilkan label di sebelah kanan bar (tanpa satuan)
                                    ctx.fillStyle = '#333333';
                                    ctx.font = 'bold 11px Arial';
                                    ctx.textAlign = 'left';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value.toFixed(0), labelX, labelY);
                                }
                            });
                            
                            ctx.restore();
                        }
                    }]
                });
            } catch (e) {
                console.error('Error rendering LSNM chart:', e);
            }
        }

        function renderMinorStopChart(records) {
            const ctx = document.getElementById('chart-minor-stop');
            if (!ctx) return;
            
            try {
                const msStats = {};
                let totalCount = 0;
                records.forEach(r => {
                    try {
                        if (r.minor_stop_data) {
                            const msData = typeof r.minor_stop_data === 'string' ? JSON.parse(r.minor_stop_data) : r.minor_stop_data;
                            msData.forEach(ms => {
                                const frequency = parseFloat(ms.frequency || 0);
                                if (ms.item) {
                                    msStats[ms.item] = (msStats[ms.item] || 0) + frequency;
                                    totalCount += frequency;
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error parsing minor stop data for chart:', e);
                    }
                });
                
                const sorted = Object.entries(msStats)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                if (sorted.length === 0) return;
                
                // Update total badge - DIPINDAH POSISINYA
                const totalBadge = document.getElementById('ms-total-badge');
                if (totalBadge) {
                    totalBadge.innerHTML = `‚è∏Ô∏è Total: ${totalCount.toFixed(0)} kali`;
                }
                
                const labels = sorted.map(s => {
                    const name = s[0];
                    return name.length > 25 ? name.substring(0, 22) + '...' : name;
                });
                const values = sorted.map(s => s[1]);
                
                chartInstances.minorStop = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Total Frequency',
                            data: values,
                            backgroundColor: '#764ba2'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { 
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const index = tooltipItems[0].dataIndex;
                                        return sorted[index][0];
                                    },
                                    label: function(context) {
                                        return `Frequency: ${context.raw} times`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            },
                            y: {
                                ticks: {
                                    font: {
                                        size: 11
                                    },
                                    autoSkip: false,
                                    maxRotation: 0
                                },
                                afterFit: function(scale) {
                                    scale.width = 180;
                                }
                            }
                        },
                        layout: {
                            padding: {
                                left: 10,
                                right: 60,
                                top: 40, // DITAMBAHKAN PADDING ATAS UNTUK BADGE
                                bottom: 10
                            }
                        }
                    },
                    plugins: [{
                        id: 'datalabels',
                        afterDatasetsDraw: function(chart) {
                            const { ctx, data, chartArea: { top, bottom, left, right, width, height } } = chart;
                            ctx.save();
                            
                            data.datasets[0].data.forEach((value, index) => {
                                const meta = chart.getDatasetMeta(0);
                                const bar = meta.data[index];
                                
                                if (bar) {
                                    const x = bar.x;
                                    const y = bar.y;
                                    const barWidth = bar.width;
                                    const barHeight = bar.height;
                                    
                                    // Hitung posisi di sebelah kanan bar
                                    const labelX = x + 5;
                                    const labelY = y;
                                    
                                    // Tampilkan label di sebelah kanan bar (tanpa satuan)
                                    ctx.fillStyle = '#333333';
                                    ctx.font = 'bold 11px Arial';
                                    ctx.textAlign = 'left';
                                    ctx.textBaseline = 'middle';
                                    ctx.fillText(value.toFixed(0), labelX, labelY);
                                }
                            });
                            
                            ctx.restore();
                        }
                    }]
                });
            } catch (e) {
                console.error('Error rendering minor stop chart:', e);
            }
        }

        // =============================================
        // INPUT PAGE FUNCTIONS
        // =============================================
        let currentMachineData = null;
        let currentMachineDetails = null;
        let customLSMCounter = 0;
        let customLSNMCounter = 0;
        let customMSCounter = 0;

        async function loadMachineData() {
            const machineId = document.getElementById('input-machine').value;
            if (!machineId) {
                document.getElementById('odt-section').style.display = 'none';
                document.getElementById('line-stop-mesin-section').style.display = 'none';
                document.getElementById('line-stop-non-mesin-section').style.display = 'none';
                document.getElementById('minor-stop-section').style.display = 'none';
                return;
            }
            
            currentMachineData = allMachines.find(m => m.id === machineId);
            showLoading('Loading machine configuration...');
            currentMachineDetails = await loadMachineDetails(machineId);
            hideLoading();
            
            // Reset counters
            customLSMCounter = 0;
            customLSNMCounter = 0;
            customMSCounter = 0;
            
            // Render ODT dengan validasi
            if (currentMachineDetails.odt.length > 0) {
                document.getElementById('odt-section').style.display = 'block';
                const odtHTML = currentMachineDetails.odt.map(odt => `
                    <div class="checkbox-item" id="odt-${odt.id}">
                        <input type="checkbox" id="odt-check-${odt.id}" onchange="toggleODT('${odt.id}')">
                        <label style="flex: 1; cursor: pointer; word-break: break-word;" for="odt-check-${odt.id}">
                            <strong>${odt.odt_name}</strong> (Standard: ${odt.standard_time} min)
                        </label>
                        <input type="number" id="odt-time-${odt.id}" min="0" 
                               placeholder="Actual time *" 
                               class="input-field odt-time-input" 
                               style="width: 120px; padding: 6px 10px;" 
                               disabled 
                               oninput="validateODTInput('${odt.id}')"
                               onblur="validateODTInput('${odt.id}')">
                        <div class="odt-error" id="odt-error-${odt.id}" style="display: none;">
                            ‚ö†Ô∏è Isi Actual Time ODT
                        </div>
                    </div>
                    <div id="odt-exceed-warning-${odt.id}" class="odt-exceed-warning" style="display: none; margin-top: -4px; margin-bottom: 8px;"></div>
                `).join('');
                document.getElementById('odt-list').innerHTML = odtHTML;
            }
            
            // Render Line Stop Mesin
            if (currentMachineDetails.lineStopMesin.length > 0) {
                document.getElementById('line-stop-mesin-section').style.display = 'block';
                const lsmHTML = currentMachineDetails.lineStopMesin.map(ls => `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <input type="checkbox" id="lsm-check-${ls.id}" onchange="toggleLineStopMesin('${ls.id}')">
                            <label style="flex: 1; font-weight: 600; word-break: break-word;" for="lsm-check-${ls.id}">${ls.item_name}</label>
                        </div>
                        <div id="lsm-details-${ls.id}" style="display: none; padding-left: 32px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <input type="number" id="lsm-duration-${ls.id}" min="0" placeholder="Duration (min)" class="input-field" style="padding: 6px 10px;" oninput="checkLSMDuration('${ls.id}')">
                                <input type="text" id="lsm-action-${ls.id}" placeholder="Action" class="input-field" style="padding: 6px 10px;">
                            </div>
                            <input type="text" id="lsm-wr-${ls.id}" placeholder="No WR" class="input-field" style="margin-top: 8px; padding: 6px 10px;">
                            <div id="lsm-warning-${ls.id}" style="display: none; margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 6px; font-size: 12px; color: var(--danger);"></div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('line-stop-mesin-list').innerHTML = lsmHTML;
            }
            
            // Render Line Stop Non Mesin
            if (currentMachineDetails.lineStopNonMesin.length > 0) {
                document.getElementById('line-stop-non-mesin-section').style.display = 'block';
                const lsnmHTML = currentMachineDetails.lineStopNonMesin.map(ls => `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <input type="checkbox" id="lsnm-check-${ls.id}" onchange="toggleLineStopNonMesin('${ls.id}')">
                            <label style="flex: 1; font-weight: 600; word-break: break-word;" for="lsnm-check-${ls.id}">${ls.item_name}</label>
                        </div>
                        <div id="lsnm-details-${ls.id}" style="display: none; padding-left: 32px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <input type="number" id="lsnm-duration-${ls.id}" min="0" placeholder="Duration (min) *" class="input-field" style="padding: 6px 10px;" oninput="updateCalculations()">
                                <input type="text" id="lsnm-action-${ls.id}" placeholder="Action *" class="input-field" style="padding: 6px 10px;">
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('line-stop-non-mesin-list').innerHTML = lsnmHTML;
            }
            
            // Render Minor Stop
            if (currentMachineDetails.minorStop.length > 0) {
                document.getElementById('minor-stop-section').style.display = 'block';
                const msHTML = currentMachineDetails.minorStop.map(ms => `
                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 8px; border: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <input type="checkbox" id="ms-check-${ms.id}" onchange="toggleMinorStop('${ms.id}')">
                            <label style="flex: 1; font-weight: 600; word-break: break-word;" for="ms-check-${ms.id}">${ms.item_name}</label>
                        </div>
                        <div id="ms-details-${ms.id}" style="display: none; padding-left: 32px;">
                            <input type="number" id="ms-frequency-${ms.id}" min="0" placeholder="Frequency (count) *" class="input-field" style="padding: 6px 10px;">
                        </div>
                    </div>
                `).join('');
                document.getElementById('minor-stop-list').innerHTML = msHTML;
            }
            
            updateCalculations();
        }

        function validateODTInput(id) {
            const checkbox = document.getElementById(`odt-check-${id}`);
            const input = document.getElementById(`odt-time-${id}`);
            const error = document.getElementById(`odt-error-${id}`);
            
            if (!checkbox || !input || !error) return true;
            
            if (checkbox.checked) {
                const value = input.value.trim();
                if (!value || isNaN(parseFloat(value)) || parseFloat(value) <= 0) {
                    input.classList.add('odt-input-error');
                    error.style.display = 'block';
                    return false;
                } else {
                    input.classList.remove('odt-input-error');
                    error.style.display = 'none';
                    const odt = currentMachineDetails.odt.find(o => o.id === id);
                    if (odt) {
                        checkODTExceed(id, odt.standard_time);
                    }
                    return true;
                }
            }
            
            input.classList.remove('odt-input-error');
            error.style.display = 'none';
            return true;
        }

        function toggleODT(id) {
            const checkbox = document.getElementById(`odt-check-${id}`);
            const input = document.getElementById(`odt-time-${id}`);
            const item = document.getElementById(`odt-${id}`);
            const error = document.getElementById(`odt-error-${id}`);
            
            if (!checkbox || !input || !item) return;
            
            input.disabled = !checkbox.checked;
            
            if (checkbox.checked) {
                item.classList.add('active');
                // Reset error state ketika dicentang
                input.classList.remove('odt-input-error');
                if (error) error.style.display = 'none';
                // Focus ke input ketika dicentang
                setTimeout(() => input.focus(), 100);
            } else {
                item.classList.remove('active');
                item.classList.remove('exceed');
                const warning = document.getElementById(`odt-exceed-warning-${id}`);
                if (warning) warning.style.display = 'none';
                if (error) error.style.display = 'none';
                input.classList.remove('odt-input-error');
            }
            
            updateCalculations();
        }

        function checkODTExceed(id, standardTime) {
            const checkbox = document.getElementById(`odt-check-${id}`);
            if (!checkbox || !checkbox.checked) return;
            
            const actualTime = parseFloat(document.getElementById(`odt-time-${id}`).value) || 0;
            const item = document.getElementById(`odt-${id}`);
            const warning = document.getElementById(`odt-exceed-warning-${id}`);
            
            if (!item || !warning) return;
            
            if (actualTime > standardTime) {
                const exceed = actualTime - standardTime;
                item.classList.add('exceed');
                warning.style.display = 'block';
                warning.innerHTML = `‚ö†Ô∏è Actual time exceed standard by <strong>${exceed.toFixed(1)} minutes</strong>. This will be added to Line Stop Non Mesin automatically.`;
            } else {
                item.classList.remove('exceed');
                warning.style.display = 'none';
            }
            
            updateCalculations();
        }

        function toggleLineStopMesin(id) {
            const checkbox = document.getElementById(`lsm-check-${id}`);
            const details = document.getElementById(`lsm-details-${id}`);
            if (!checkbox || !details) return;
            
            details.style.display = checkbox.checked ? 'block' : 'none';
            updateCalculations();
        }

        function toggleLineStopNonMesin(id) {
            const checkbox = document.getElementById(`lsnm-check-${id}`);
            const details = document.getElementById(`lsnm-details-${id}`);
            if (!checkbox || !details) return;
            
            details.style.display = checkbox.checked ? 'block' : 'none';
            updateCalculations();
        }
        
        function toggleMinorStop(id) {
            const checkbox = document.getElementById(`ms-check-${id}`);
            const details = document.getElementById(`ms-details-${id}`);
            if (!checkbox || !details) return;
            
            details.style.display = checkbox.checked ? 'block' : 'none';
        }

        function checkLSMDuration(id) {
            const duration = parseFloat(document.getElementById(`lsm-duration-${id}`).value) || 0;
            const actionField = document.getElementById(`lsm-action-${id}`);
            const wrField = document.getElementById(`lsm-wr-${id}`);
            const warning = document.getElementById(`lsm-warning-${id}`);
            
            if (!actionField || !wrField || !warning) return;
            
            if (duration >= 180) {
                warning.style.display = 'block';
                warning.textContent = '‚ö†Ô∏è Duration ‚â• 180 minutes: Action and WR Number are REQUIRED';
                actionField.required = true;
                wrField.required = true;
            } else {
                warning.style.display = 'none';
                actionField.required = false;
                wrField.required = false;
            }
            
            updateCalculations();
        }

        function addCustomLineStopMesin() {
            customLSMCounter++;
            const container = document.getElementById('custom-line-stop-mesin-container');
            if (!container) return;
            
            const html = `
                <div id="custom-lsm-${customLSMCounter}" style="background: rgba(102, 125, 234, 0.1); padding: 12px; border-radius: 8px; margin-top: 12px; border: 2px solid var(--accent-primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 8px;">
                        <strong style="color: var(--accent-primary); word-break: break-word;">Custom Line Stop Mesin #${customLSMCounter}</strong>
                        <button type="button" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; white-space: nowrap;" onclick="removeCustomLSM(${customLSMCounter})">Remove</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <input type="text" id="custom-lsm-item-${customLSMCounter}" placeholder="Item Name *" class="input-field" style="padding: 6px 10px;">
                        <input type="number" id="custom-lsm-duration-${customLSMCounter}" min="0" placeholder="Duration (min) *" class="input-field" style="padding: 6px 10px;" oninput="checkCustomLSMDuration(${customLSMCounter})">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <input type="text" id="custom-lsm-action-${customLSMCounter}" placeholder="Action" class="input-field" style="padding: 6px 10px;">
                        <input type="text" id="custom-lsm-wr-${customLSMCounter}" placeholder="No WR" class="input-field" style="padding: 6px 10px;">
                    </div>
                    <div id="custom-lsm-warning-${customLSMCounter}" style="display: none; margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); border-radius: 6px; font-size: 12px; color: var(--danger);"></div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeCustomLSM(id) {
            const element = document.getElementById(`custom-lsm-${id}`);
            if (element) element.remove();
            updateCalculations();
        }

        function checkCustomLSMDuration(id) {
            const duration = parseFloat(document.getElementById(`custom-lsm-duration-${id}`).value) || 0;
            const warning = document.getElementById(`custom-lsm-warning-${id}`);
            
            if (!warning) return;
            
            if (duration >= 180) {
                warning.style.display = 'block';
                warning.textContent = '‚ö†Ô∏è Duration ‚â• 180 minutes: Action and WR Number are REQUIRED';
            } else {
                warning.style.display = 'none';
            }
            
            updateCalculations();
        }

        function addCustomLineStopNonMesin() {
            customLSNMCounter++;
            const container = document.getElementById('custom-line-stop-non-mesin-container');
            if (!container) return;
            
            const html = `
                <div id="custom-lsnm-${customLSNMCounter}" style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px; margin-top: 12px; border: 2px solid var(--warning);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 8px;">
                        <strong style="color: var(--warning); word-break: break-word;">Custom Line Stop Non Mesin #${customLSNMCounter}</strong>
                        <button type="button" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; white-space: nowrap;" onclick="removeCustomLSNM(${customLSNMCounter})">Remove</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <input type="text" id="custom-lsnm-item-${customLSNMCounter}" placeholder="Item Name *" class="input-field" style="padding: 6px 10px;">
                        <input type="number" id="custom-lsnm-duration-${customLSNMCounter}" min="0" placeholder="Duration (min) *" class="input-field" style="padding: 6px 10px;" oninput="updateCalculations()">
                    </div>
                    <input type="text" id="custom-lsnm-action-${customLSNMCounter}" placeholder="Action *" class="input-field" style="margin-top: 8px; padding: 6px 10px;">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        function removeCustomLSNM(id) {
            const element = document.getElementById(`custom-lsnm-${id}`);
            if (element) element.remove();
            updateCalculations();
        }
        
        function addCustomMinorStop() {
            customMSCounter++;
            const container = document.getElementById('custom-minor-stop-container');
            if (!container) return;
            
            const html = `
                <div id="custom-ms-${customMSCounter}" style="background: rgba(118, 75, 162, 0.1); padding: 12px; border-radius: 8px; margin-top: 12px; border: 2px solid var(--accent-secondary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 8px;">
                        <strong style="color: var(--accent-secondary); word-break: break-word;">Custom Minor Stop #${customMSCounter}</strong>
                        <button type="button" class="btn btn-danger" style="padding: 4px 8px; font-size: 12px; white-space: nowrap;" onclick="removeCustomMS(${customMSCounter})">Remove</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <input type="text" id="custom-ms-item-${customMSCounter}" placeholder="Item Name *" class="input-field" style="padding: 6px 10px;">
                        <input type="number" id="custom-ms-frequency-${customMSCounter}" min="0" placeholder="Frequency (count) *" class="input-field" style="padding: 6px 10px;">
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
        
        function removeCustomMS(id) {
            const element = document.getElementById(`custom-ms-${id}`);
            if (element) element.remove();
        }

        function updateCalculations() {
            const shift = document.getElementById('input-shift')?.value;
            const output = parseFloat(document.getElementById('input-output')?.value) || 0;
            const reject = parseFloat(document.getElementById('input-reject')?.value) || 0;
            
            if (!currentMachineData || !shift) {
                const targetText = document.getElementById('target-text');
                const targetDetails = document.getElementById('target-details');
                if (targetText) {
                    targetText.innerHTML = '<span style="color: var(--text-secondary); word-break: break-word;">Select Machine and Shift to see target</span>';
                }
                if (targetDetails) {
                    targetDetails.innerHTML = 'Target akan otomatis dihitung berdasarkan available time (shift - ODT - line stops) √ó target per minute';
                }
                if (output === 0) {
                    const results = document.getElementById('calculated-results');
                    if (results) results.style.display = 'none';
                }
                return;
            }
            
            if (output === 0) {
                const results = document.getElementById('calculated-results');
                if (results) results.style.display = 'none';
            }
            
            // Collect ODT data
            const odtData = [];
            if (currentMachineDetails && currentMachineDetails.odt) {
                currentMachineDetails.odt.forEach(odt => {
                    const checkbox = document.getElementById(`odt-check-${odt.id}`);
                    if (!checkbox) return;
                    
                    const checked = checkbox.checked;
                    const input = document.getElementById(`odt-time-${odt.id}`);
                    const actualTime = parseFloat(input?.value) || 0;
                    odtData.push({
                        name: odt.odt_name,
                        standardTime: odt.standard_time,
                        actualTime: actualTime,
                        checked: checked
                    });
                });
            }
            
            // Collect Line Stop Mesin data
            const lineStopMesinData = [];
            if (currentMachineDetails && currentMachineDetails.lineStopMesin) {
                currentMachineDetails.lineStopMesin.forEach(ls => {
                    const checkbox = document.getElementById(`lsm-check-${ls.id}`);
                    if (!checkbox || !checkbox.checked) return;
                    
                    const duration = document.getElementById(`lsm-duration-${ls.id}`)?.value || 0;
                    const action = document.getElementById(`lsm-action-${ls.id}`)?.value || '';
                    const wr = document.getElementById(`lsm-wr-${ls.id}`)?.value || '';
                    lineStopMesinData.push({
                        item: ls.item_name,
                        duration: duration,
                        action: action,
                        wr: wr
                    });
                });
            }
            
            // Collect Custom Line Stop Mesin
            for (let i = 1; i <= customLSMCounter; i++) {
                const itemEl = document.getElementById(`custom-lsm-item-${i}`);
                if (itemEl && itemEl.value) {
                    const duration = document.getElementById(`custom-lsm-duration-${i}`)?.value || 0;
                    const action = document.getElementById(`custom-lsm-action-${i}`)?.value || '';
                    const wr = document.getElementById(`custom-lsm-wr-${i}`)?.value || '';
                    lineStopMesinData.push({
                        item: itemEl.value,
                        duration: duration,
                        action: action,
                        wr: wr
                    });
                }
            }
            
            // Collect Line Stop Non Mesin data
            const lineStopNonMesinData = [];
            if (currentMachineDetails && currentMachineDetails.lineStopNonMesin) {
                currentMachineDetails.lineStopNonMesin.forEach(ls => {
                    const checkbox = document.getElementById(`lsnm-check-${ls.id}`);
                    if (!checkbox || !checkbox.checked) return;
                    
                    const duration = document.getElementById(`lsnm-duration-${ls.id}`)?.value || 0;
                    const action = document.getElementById(`lsnm-action-${ls.id}`)?.value || '';
                    lineStopNonMesinData.push({
                        item: ls.item_name,
                        duration: duration,
                        action: action
                    });
                });
            }
            
            // Collect Custom Line Stop Non Mesin
            for (let i = 1; i <= customLSNMCounter; i++) {
                const itemEl = document.getElementById(`custom-lsnm-item-${i}`);
                if (itemEl && itemEl.value) {
                    const duration = document.getElementById(`custom-lsnm-duration-${i}`)?.value || 0;
                    const action = document.getElementById(`custom-lsnm-action-${i}`)?.value || '';
                    lineStopNonMesinData.push({
                        item: itemEl.value,
                        duration: duration,
                        action: action
                    });
                }
            }
            
            const formData = {
                shift: shift,
                targetPerMinute: currentMachineData.target_per_minute,
                actualOutput: output,
                reject: reject,
                odtData: odtData,
                lineStopMesinData: lineStopMesinData,
                lineStopNonMesinData: lineStopNonMesinData
            };
            
            const results = calculateOEE(formData);
            
            // Display ODT Exceeds
            const odtExceedContainer = document.getElementById('odt-exceed-list');
            if (odtExceedContainer) {
                if (results.odtExceeds.length > 0) {
                    const exceedHTML = `
                        <div style="background: rgba(245, 158, 11, 0.15); padding: 16px; border-radius: 8px; border: 2px solid var(--warning); margin-top: 16px;">
                            <h5 style="font-weight: 700; color: var(--warning); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; word-break: break-word;">
                                ‚ö†Ô∏è Auto-Generated Line Stop Non Mesin (from ODT Exceed)
                            </h5>
                            ${results.odtExceeds.map(ex => `
                                <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid var(--warning);">
                                    <div style="font-weight: 600; color: var(--text-primary); word-break: break-word;">${ex.item}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px; word-break: break-word;">
                                        Duration: <strong>${ex.duration.toFixed(1)} minutes</strong> | Action: ${ex.action}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    odtExceedContainer.innerHTML = exceedHTML;
                } else {
                    odtExceedContainer.innerHTML = '';
                }
            }
            
            // Update target recommendation
            const targetText = document.getElementById('target-text');
            const targetDetails = document.getElementById('target-details');
            
            if (targetText && targetDetails) {
                const targetOutput = Math.round(results.remainingTime * currentMachineData.target_per_minute);
                targetText.innerHTML = `
                    <strong style="font-size: 24px; color: var(--accent-primary); word-break: break-word;">${targetOutput.toLocaleString('id-ID')} units</strong>
                `;
                targetDetails.innerHTML = `
                    üìä <strong>Calculation:</strong> ${results.remainingTime.toFixed(0)} minutes (available time) √ó ${currentMachineData.target_per_minute}/min (target per minute)<br>
                    ‚è±Ô∏è <strong>Available Time Breakdown:</strong> ${results.shiftMinutes} min (shift) - ${results.totalODT.toFixed(0)} min (ODT) - ${results.totalLineStopMesin.toFixed(0)} min (LS Mesin) - ${results.totalLineStopNonMesin.toFixed(0)} min (LS Non Mesin) = <strong>${results.remainingTime.toFixed(0)} min</strong>
                `;
            }
            
            // Show calculated results
            const resultsElement = document.getElementById('calculated-results');
            if (resultsElement) {
                resultsElement.style.display = 'block';
                
                const aActualEl = document.getElementById('calc-a-actual');
                const a365El = document.getElementById('calc-a-365');
                const pEl = document.getElementById('calc-p');
                const qEl = document.getElementById('calc-q');
                const oeeActualEl = document.getElementById('calc-oee-actual');
                const oee365El = document.getElementById('calc-oee-365');
                
                if (aActualEl) {
                    aActualEl.textContent = `${results.availabilityActual.toFixed(1)}%`;
                    aActualEl.style.color = results.availabilityActual >= 91 ? 'var(--success)' : 'var(--danger)';
                }
                
                if (a365El) {
                    a365El.textContent = `${results.availability365.toFixed(1)}%`;
                    a365El.style.color = 'var(--accent-primary)';
                }
                
                if (pEl) {
                    pEl.textContent = `${results.performance.toFixed(1)}%`;
                    pEl.style.color = results.performance >= 98 ? 'var(--success)' : 'var(--danger)';
                }
                
                if (qEl) {
                    qEl.textContent = `${results.quality.toFixed(1)}%`;
                    qEl.style.color = results.quality >= 99 ? 'var(--success)' : 'var(--danger)';
                }
                
                if (oeeActualEl) {
                    oeeActualEl.textContent = `${results.oeeActual.toFixed(1)}%`;
                    oeeActualEl.style.color = results.oeeActual >= 88 ? 'var(--success)' : 'var(--danger)';
                }
                
                if (oee365El) {
                    oee365El.textContent = `${results.oee365.toFixed(1)}%`;
                    oee365El.style.color = results.oee365 >= 55 ? 'var(--success)' : 'var(--danger)';
                }
            }
        }

        async function saveOEEData() {
            const date = document.getElementById('input-date')?.value;
            const shift = document.getElementById('input-shift')?.value;
            const machineId = document.getElementById('input-machine')?.value;
            const pic = document.getElementById('input-pic')?.value.toUpperCase() || '';
            const productCode = document.getElementById('input-product')?.value.toUpperCase() || '';
            const batchNumber = document.getElementById('input-batch')?.value.toUpperCase() || '';
            const output = parseFloat(document.getElementById('input-output')?.value) || 0;
            const reject = parseFloat(document.getElementById('input-reject')?.value) || 0;
            const notes = document.getElementById('input-notes')?.value || '';
            
            if (!date || !shift || !machineId || !pic || !productCode || !batchNumber || output === 0) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            if (!currentMachineData) {
                showToast('Please select a machine', 'error');
                return;
            }
            
            // VALIDASI: Cek semua ODT yang dicentang harus ada actual time
            let hasODTValidationError = false;
            let firstInvalidODTInput = null;
            
            if (currentMachineDetails && currentMachineDetails.odt) {
                for (const odt of currentMachineDetails.odt) {
                    const checkbox = document.getElementById(`odt-check-${odt.id}`);
                    if (checkbox && checkbox.checked) {
                        const input = document.getElementById(`odt-time-${odt.id}`);
                        const actualTime = input?.value.trim();
                        
                        if (!actualTime || isNaN(parseFloat(actualTime)) || parseFloat(actualTime) <= 0) {
                            hasODTValidationError = true;
                            showToast(`ODT "${odt.odt_name}": Isi Actual Time ODT`, 'error');
                            
                            // Highlight input yang error
                            input.classList.add('odt-input-error');
                            const error = document.getElementById(`odt-error-${odt.id}`);
                            if (error) error.style.display = 'block';
                            
                            // Scroll ke input yang error (hanya yang pertama)
                            if (!firstInvalidODTInput) {
                                firstInvalidODTInput = input;
                            }
                        }
                    }
                }
            }
            
            if (hasODTValidationError) {
                if (firstInvalidODTInput) {
                    firstInvalidODTInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstInvalidODTInput.focus();
                }
                throw new Error('ODT validation failed');
            }
            
            // Collect all data
            const odtData = [];
            if (currentMachineDetails && currentMachineDetails.odt) {
                currentMachineDetails.odt.forEach(odt => {
                    const checkbox = document.getElementById(`odt-check-${odt.id}`);
                    if (!checkbox) return;
                    
                    const checked = checkbox.checked;
                    if (checked) {
                        const input = document.getElementById(`odt-time-${odt.id}`);
                        const actualTime = parseFloat(input?.value) || 0;
                        
                        odtData.push({
                            name: odt.odt_name,
                            standardTime: odt.standard_time,
                            actualTime: actualTime,
                            checked: checked
                        });
                    }
                });
            }
            
            const lineStopMesinData = [];
            if (currentMachineDetails && currentMachineDetails.lineStopMesin) {
                currentMachineDetails.lineStopMesin.forEach(ls => {
                    const checkbox = document.getElementById(`lsm-check-${ls.id}`);
                    if (!checkbox || !checkbox.checked) return;
                    
                    const duration = parseFloat(document.getElementById(`lsm-duration-${ls.id}`)?.value) || 0;
                    const action = document.getElementById(`lsm-action-${ls.id}`)?.value || '';
                    const wr = document.getElementById(`lsm-wr-${ls.id}`)?.value || '';
                    
                    if (duration >= 180 && (!action || !wr)) {
                        showToast(`Line Stop Mesin "${ls.item_name}": Action and WR required for duration ‚â• 180 min`, 'error');
                        throw new Error('Validation failed');
                    }
                    
                    lineStopMesinData.push({
                        item: ls.item_name,
                        duration: duration,
                        action: action,
                        wr: wr
                    });
                });
            }
            
            // Custom LSM
            for (let i = 1; i <= customLSMCounter; i++) {
                const itemEl = document.getElementById(`custom-lsm-item-${i}`);
                if (itemEl && itemEl.value) {
                    const item = itemEl.value;
                    const duration = parseFloat(document.getElementById(`custom-lsm-duration-${i}`)?.value) || 0;
                    const action = document.getElementById(`custom-lsm-action-${i}`)?.value || '';
                    const wr = document.getElementById(`custom-lsm-wr-${i}`)?.value || '';
                    
                    if (!duration) {
                        showToast(`Custom Line Stop Mesin "${item}": Duration is required`, 'error');
                        throw new Error('Validation failed');
                    }
                    
                    if (duration >= 180 && (!action || !wr)) {
                        showToast(`Custom Line Stop Mesin "${item}": Action and WR required for duration ‚â• 180 min`, 'error');
                        throw new Error('Validation failed');
                    }
                    
                    lineStopMesinData.push({ item, duration, action, wr });
                }
            }
            
            const lineStopNonMesinData = [];
            if (currentMachineDetails && currentMachineDetails.lineStopNonMesin) {
                currentMachineDetails.lineStopNonMesin.forEach(ls => {
                    const checkbox = document.getElementById(`lsnm-check-${ls.id}`);
                    if (!checkbox || !checkbox.checked) return;
                    
                    const duration = parseFloat(document.getElementById(`lsnm-duration-${ls.id}`)?.value) || 0;
                    const action = document.getElementById(`lsnm-action-${ls.id}`)?.value || '';
                    
                    if (!action) {
                        showToast(`Line Stop Non Mesin "${ls.item_name}": Action is required`, 'error');
                        throw new Error('Validation failed');
                    }
                    
                    lineStopNonMesinData.push({
                        item: ls.item_name,
                        duration: duration,
                        action: action
                    });
                });
            }
            
            // Custom LSNM
            for (let i = 1; i <= customLSNMCounter; i++) {
                const itemEl = document.getElementById(`custom-lsnm-item-${i}`);
                if (itemEl && itemEl.value) {
                    const item = itemEl.value;
                    const duration = parseFloat(document.getElementById(`custom-lsnm-duration-${i}`)?.value) || 0;
                    const action = document.getElementById(`custom-lsnm-action-${i}`)?.value || '';
                    
                    if (!duration || !action) {
                        showToast(`Custom Line Stop Non Mesin "${item}": Duration and Action are required`, 'error');
                        throw new Error('Validation failed');
                    }
                    
                    lineStopNonMesinData.push({ item, duration, action });
                }
            }
            
            // Collect Minor Stop data
            const minorStopData = [];
            let totalMinorStopCount = 0;
            
            if (currentMachineDetails && currentMachineDetails.minorStop) {
                currentMachineDetails.minorStop.forEach(ms => {
                    const checkbox = document.getElementById(`ms-check-${ms.id}`);
                    if (!checkbox || !checkbox.checked) return;
                    
                    const frequency = parseFloat(document.getElementById(`ms-frequency-${ms.id}`)?.value) || 0;
                    
                    if (frequency > 0) {
                        minorStopData.push({
                            item: ms.item_name,
                            frequency: frequency
                        });
                        totalMinorStopCount += frequency;
                    }
                });
            }
            
            // Collect Custom Minor Stop
            for (let i = 1; i <= customMSCounter; i++) {
                const itemEl = document.getElementById(`custom-ms-item-${i}`);
                if (itemEl && itemEl.value) {
                    const item = itemEl.value;
                    const frequency = parseFloat(document.getElementById(`custom-ms-frequency-${i}`)?.value) || 0;
                    
                    if (!frequency) {
                        showToast(`Custom Minor Stop "${item}": Frequency is required`, 'error');
                        throw new Error('Validation failed');
                    }
                    
                    minorStopData.push({ item, frequency });
                    totalMinorStopCount += frequency;
                }
            }
            
            const formData = {
                shift: shift,
                targetPerMinute: currentMachineData.target_per_minute,
                actualOutput: output,
                reject: reject,
                odtData: odtData,
                lineStopMesinData: lineStopMesinData,
                lineStopNonMesinData: lineStopNonMesinData
            };
            
            const results = calculateOEE(formData);
            
            // Add ODT exceeds to lineStopNonMesinData before saving
            const finalLineStopNonMesinData = [...lineStopNonMesinData, ...results.odtExceeds];
            
            const recordData = {
                date: date,
                shift: shift,
                shift_minutes: SHIFTS[shift].minutes,
                machine_name: currentMachineData.machine_name,
                machine_id: machineId,
                pic: pic,
                product_code: productCode,
                batch_number: batchNumber,
                odt_data: odtData,
                line_stop_mesin_data: lineStopMesinData,
                line_stop_non_mesin_data: finalLineStopNonMesinData,
                minor_stop_data: minorStopData,
                minor_stop_count: totalMinorStopCount,
                actual_output: output,
                reject: reject,
                availability_actual: results.availabilityActual,
                availability_365: results.availability365,
                performance: results.performance,
                quality: results.quality,
                oee_actual: results.oeeActual,
                oee_365: results.oee365,
                notes: notes
            };
            
            showLoading('Saving OEE data...');
            
            try {
                const saved = await saveOEERecord(recordData);
                allOEERecords.unshift(saved);
                hideLoading();
                showToast('‚úÖ OEE data saved successfully!', 'success');
                resetInputForm();
            } catch (error) {
                hideLoading();
                if (error.message !== 'Validation failed' && error.message !== 'ODT validation failed') {
                    showToast('Failed to save OEE data', 'error');
                }
            }
        }

        function resetInputForm() {
            document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('input-shift').value = '';
            document.getElementById('input-machine').value = '';
            document.getElementById('input-pic').value = '';
            document.getElementById('input-product').value = '';
            document.getElementById('input-batch').value = '';
            document.getElementById('input-output').value = '';
            document.getElementById('input-reject').value = '0';
            document.getElementById('input-notes').value = '';
            
            document.getElementById('odt-section').style.display = 'none';
            document.getElementById('line-stop-mesin-section').style.display = 'none';
            document.getElementById('line-stop-non-mesin-section').style.display = 'none';
            document.getElementById('minor-stop-section').style.display = 'none';
            document.getElementById('calculated-results').style.display = 'none';
            
            // Reset target to default message
            const targetText = document.getElementById('target-text');
            const targetDetails = document.getElementById('target-details');
            if (targetText) {
                targetText.innerHTML = '<span style="color: var(--text-secondary); word-break: break-word;">Select Machine and Shift to see target</span>';
            }
            if (targetDetails) {
                targetDetails.innerHTML = 'Target akan otomatis dihitung berdasarkan available time (shift - ODT - line stops) √ó target per minute';
            }
            
            const containers = [
                'custom-line-stop-mesin-container',
                'custom-line-stop-non-mesin-container',
                'custom-minor-stop-container',
                'odt-exceed-list'
            ];
            
            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = '';
            });
            
            customLSMCounter = 0;
            customLSNMCounter = 0;
            customMSCounter = 0;
            
            currentMachineData = null;
            currentMachineDetails = null;
            
            showToast('Form reset', 'success');
        }

        // =============================================
        // MANAGEMENT FUNCTIONS
        // =============================================
        function unlockManagement() {
            const password = document.getElementById('mgmt-password').value;
            if (password === MANAGEMENT_PASSWORD) {
                isManagementUnlocked = true;
                showToast('Management unlocked', 'success');
                renderApp();
            } else {
                showToast('Incorrect password', 'error');
            }
        }

        let editingMachineId = null;
        let machineFormData = {
            odtItems: [],
            lsmItems: [],
            lsnmItems: [],
            msItems: []
        };

        function openAddMachineModal() {
            editingMachineId = null;
            machineFormData = { odtItems: [], lsmItems: [], lsnmItems: [], msItems: [] };
            
            showModal(`
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 24px; word-break: break-word;">‚ûï Add New Machine</h3>
                
                <div style="margin-bottom: 20px;">
                    <label class="label">Machine Name *</label>
                    <input type="text" id="modal-machine-name" class="input-field" style="text-transform: uppercase;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div>
                        <label class="label">Area *</label>
                        <select id="modal-machine-area" class="input-field">
                            <option value="">Select Area</option>
                            <option value="Injeksi">Injeksi</option>
                            <option value="Non Injeksi">Non Injeksi</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Target per Minute *</label>
                        <input type="number" id="modal-machine-target" min="0" step="0.01" class="input-field">
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label class="label">PIC</label>
                    <input type="text" id="modal-machine-pic" class="input-field" style="text-transform: uppercase;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="font-weight: 700; margin-bottom: 12px;">ODT Items</h4>
                    <div id="modal-odt-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="addODTItem()">‚ûï Add ODT</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="font-weight: 700; margin-bottom: 12px;">Line Stop Mesin Items</h4>
                    <div id="modal-lsm-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="addLSMItem()">üîß Add Line Stop Mesin</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="font-weight: 700; margin-bottom: 12px;">Line Stop Non Mesin Items</h4>
                    <div id="modal-lsnm-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="addLSNMItem()">‚ûï Add Line Stop Non Mesin</button>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h4 style="font-weight: 700; margin-bottom: 12px;">Minor Stop Items</h4>
                    <div id="modal-ms-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="addMSItem()">‚ûï Add Minor Stop</button>
                </div>
                
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <button class="btn btn-primary" style="flex: 1; min-width: 120px;" onclick="saveMachineModal()">üíæ Save Machine</button>
                    <button class="btn btn-secondary" style="flex: 1; min-width: 120px;" onclick="closeModal()">Cancel</button>
                </div>
            `);
            
            renderMachineFormLists();
        }

        async function editMachine(machineId) {
            editingMachineId = machineId;
            const machine = allMachines.find(m => m.id === machineId);
            
            showLoading('Loading machine details...');
            const details = await loadMachineDetails(machineId);
            hideLoading();
            
            machineFormData = {
                odtItems: details.odt.map(o => ({ name: o.odt_name, time: o.standard_time })),
                lsmItems: details.lineStopMesin.map(l => l.item_name),
                lsnmItems: details.lineStopNonMesin.map(l => l.item_name),
                msItems: details.minorStop.map(m => m.item_name)
            };
            
            showModal(`
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 24px; word-break: break-word;">‚úèÔ∏è Edit Machine</h3>
                
                <div style="margin-bottom: 20px;">
                    <label class="label">Machine Name *</label>
                    <input type="text" id="modal-machine-name" value="${machine.machine_name}" class="input-field" style="text-transform: uppercase;">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                    <div>
                        <label class="label">Area *</label>
                        <select id="modal-machine-area" class="input-field">
                            <option value="">Select Area</option>
                            <option value="Injeksi" ${machine.area === 'Injeksi' ? 'selected' : ''}>Injeksi</option>
                            <option value="Non Injeksi" ${machine.area === 'Non Injeksi' ? 'selected' : ''}>Non Injeksi</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Target per Minute *</label>
                        <input type="number" id="modal-machine-target" value="${machine.target_per_minute}" min="0" step="0.01" class="input-field">
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label class="label">PIC</label>
                    <input type="text" id="modal-machine-pic" value="${machine.pic || ''}" class="input-field" style="text-transform: uppercase;">
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="font-weight: 700; margin-bottom: 12px;">ODT Items</h4>
                    <div id="modal-odt-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="addODTItem()">‚ûï Add ODT</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="font-weight: 700; margin-bottom: 12px;">Line Stop Mesin Items</h4>
                    <div id="modal-lsm-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="addLSMItem()">üîß Add Line Stop Mesin</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="font-weight: 700; margin-bottom: 12px;">Line Stop Non Mesin Items</h4>
                    <div id="modal-lsnm-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="addLSNMItem()">‚ûï Add Line Stop Non Mesin</button>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h4 style="font-weight: 700; margin-bottom: 12px;">Minor Stop Items</h4>
                    <div id="modal-ms-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;"></div>
                    <button type="button" class="btn btn-secondary" style="width: 100%;" onclick="addMSItem()">‚ûï Add Minor Stop</button>
                </div>
                
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <button class="btn btn-primary" style="flex: 1; min-width: 120px;" onclick="saveMachineModal()">üíæ Update Machine</button>
                    <button class="btn btn-secondary" style="flex: 1; min-width: 120px;" onclick="closeModal()">Cancel</button>
                </div>
            `);
            
            renderMachineFormLists();
        }

        function addODTItem() {
            machineFormData.odtItems.push({ name: '', time: 0 });
            renderMachineFormLists();
        }

        function addLSMItem() {
            machineFormData.lsmItems.push('');
            renderMachineFormLists();
        }

        function addLSNMItem() {
            machineFormData.lsnmItems.push('');
            renderMachineFormLists();
        }

        function addMSItem() {
            machineFormData.msItems.push('');
            renderMachineFormLists();
        }

        function removeODTItem(index) {
            machineFormData.odtItems.splice(index, 1);
            renderMachineFormLists();
        }

        function removeLSMItem(index) {
            machineFormData.lsmItems.splice(index, 1);
            renderMachineFormLists();
        }

        function removeLSNMItem(index) {
            machineFormData.lsnmItems.splice(index, 1);
            renderMachineFormLists();
        }

        function removeMSItem(index) {
            machineFormData.msItems.splice(index, 1);
            renderMachineFormLists();
        }

        function renderMachineFormLists() {
            // ODT List
            const odtList = document.getElementById('modal-odt-list');
            if (odtList) {
                odtList.innerHTML = machineFormData.odtItems.map((item, i) => `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                        <input type="text" value="${item.name}" placeholder="ODT Name" class="input-field" style="flex: 2; min-width: 150px; text-transform: uppercase;" onchange="machineFormData.odtItems[${i}].name = this.value.toUpperCase()">
                        <input type="number" value="${item.time}" min="0" placeholder="Minutes" class="input-field" style="flex: 1; min-width: 100px;" onchange="machineFormData.odtItems[${i}].time = parseFloat(this.value)">
                        <button type="button" class="btn btn-danger" style="padding: 10px; min-width: 50px;" onclick="removeODTItem(${i})">‚úï</button>
                    </div>
                `).join('');
            }
            
            // LSM List
            const lsmList = document.getElementById('modal-lsm-list');
            if (lsmList) {
                lsmList.innerHTML = machineFormData.lsmItems.map((item, i) => `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                        <input type="text" value="${item}" placeholder="Line Stop Mesin Item" class="input-field" style="flex: 1; min-width: 200px; text-transform: uppercase;" onchange="machineFormData.lsmItems[${i}] = this.value.toUpperCase()">
                        <button type="button" class="btn btn-danger" style="padding: 10px; min-width: 50px;" onclick="removeLSMItem(${i})">‚úï</button>
                    </div>
                `).join('');
            }
            
            // LSNM List
            const lsnmList = document.getElementById('modal-lsnm-list');
            if (lsnmList) {
                lsnmList.innerHTML = machineFormData.lsnmItems.map((item, i) => `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                        <input type="text" value="${item}" placeholder="Line Stop Non Mesin Item" class="input-field" style="flex: 1; min-width: 200px; text-transform: uppercase;" onchange="machineFormData.lsnmItems[${i}] = this.value.toUpperCase()">
                        <button type="button" class="btn btn-danger" style="padding: 10px; min-width: 50px;" onclick="removeLSNMItem(${i})">‚úï</button>
                    </div>
                `).join('');
            }
            
            // MS List
            const msList = document.getElementById('modal-ms-list');
            if (msList) {
                msList.innerHTML = machineFormData.msItems.map((item, i) => `
                    <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                        <input type="text" value="${item}" placeholder="Minor Stop Item" class="input-field" style="flex: 1; min-width: 200px; text-transform: uppercase;" onchange="machineFormData.msItems[${i}] = this.value.toUpperCase()">
                        <button type="button" class="btn btn-danger" style="padding: 10px; min-width: 50px;" onclick="removeMSItem(${i})">‚úï</button>
                    </div>
                `).join('');
            }
        }

        async function saveMachineModal() {
            const machineName = document.getElementById('modal-machine-name')?.value.toUpperCase() || '';
            const area = document.getElementById('modal-machine-area')?.value || '';
            const target = parseFloat(document.getElementById('modal-machine-target')?.value) || 0;
            const pic = document.getElementById('modal-machine-pic')?.value.toUpperCase() || '';
            
            if (!machineName || !area || target === 0) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            const machineData = {
                machine_name: machineName,
                area: area,
                target_per_minute: target,
                pic: pic,
                is_deleted: false
            };
            
            const odtItems = machineFormData.odtItems.filter(o => o.name && o.time > 0);
            const lsmItems = machineFormData.lsmItems.filter(l => l);
            const lsnmItems = machineFormData.lsnmItems.filter(l => l);
            const msItems = machineFormData.msItems.filter(m => m);
            
            showLoading(editingMachineId ? 'Updating machine...' : 'Saving machine...');
            
            try {
                if (editingMachineId) {
                    await updateMachine(editingMachineId, machineData, odtItems, lsmItems, lsnmItems, msItems);
                    showToast('Machine updated successfully', 'success');
                } else {
                    const saved = await saveMachine(machineData, odtItems, lsmItems, lsnmItems, msItems);
                    allMachines.push(saved);
                    showToast('Machine added successfully', 'success');
                }
                
                await loadMachines();
                hideLoading();
                closeModal();
                renderApp();
            } catch (error) {
                hideLoading();
                showToast('Failed to save machine', 'error');
            }
        }

        function confirmDeleteMachine(machineId, machineName) {
            showModal(`
                <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 16px; color: var(--danger); word-break: break-word;">‚ö†Ô∏è Confirm Delete</h3>
                <p style="font-size: 16px; margin-bottom: 24px; word-break: break-word;">Are you sure you want to delete machine <strong>"${machineName}"</strong>?</p>
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                    <button class="btn btn-danger" style="flex: 1; min-width: 120px;" onclick="deleteMachineConfirmed('${machineId}')">Yes, Delete</button>
                    <button class="btn btn-secondary" style="flex: 1; min-width: 120px;" onclick="closeModal()">Cancel</button>
                </div>
            `);
        }

        async function deleteMachineConfirmed(machineId) {
            showLoading('Deleting machine...');
            
            try {
                await deleteMachine(machineId);
                allMachines = allMachines.filter(m => m.id !== machineId);
                hideLoading();
                showToast('Machine deleted successfully', 'success');
                closeModal();
                renderApp();
            } catch (error) {
                hideLoading();
                showToast('Failed to delete machine', 'error');
            }
        }

        // =============================================
        // EXPORT FUNCTIONS
        // =============================================
        function exportData() {
            const startDate = document.getElementById('export-start-date')?.value;
            const endDate = document.getElementById('export-end-date')?.value;
            const format = document.getElementById('export-format')?.value;
            
            if (!startDate || !endDate) {
                showToast('Please select date range', 'error');
                return;
            }
            
            const filtered = allOEERecords.filter(r => {
                if (!r.date) return false;
                const rDate = new Date(r.date);
                const sDate = new Date(startDate);
                const eDate = new Date(endDate);
                return rDate >= sDate && rDate <= eDate;
            });
            
            if (filtered.length === 0) {
                showToast('No data found in selected date range', 'error');
                return;
            }
            
            if (format === 'pdf') {
                exportToPDF(filtered, startDate, endDate);
            } else {
                exportToExcel(filtered, startDate, endDate);
            }
        }
        
        function exportToExcel(records, startDate, endDate) {
            try {
                const delimiter = '\t';
                
                // Headers
                const headers = [
                    'Date', 'Shift', 'Machine', 'PIC', 'Product Code', 'Batch Number',
                    'Actual Output', 'Reject', 'Minor Stop Count',
                    'Availability %', 'Performance %', 'Quality %', 'Availability 365 %',
                    'OEE Actual %', 'OEE 365 %',
                    'Total ODT (min)', 'Total Line Stop Mesin (min)', 'Total Line Stop Non Mesin (min)',
                    'Notes'
                ];
                
                const rows = records.map(r => {
                    let totalODT = 0;
                    try {
                        const odtData = typeof r.odt_data === 'string' ? JSON.parse(r.odt_data) : (r.odt_data || []);
                        odtData.forEach(odt => {
                            if (odt.checked) {
                                const actualTime = parseFloat(odt.actualTime || 0);
                                const standardTime = parseFloat(odt.standardTime || 0);
                                totalODT += Math.min(actualTime, standardTime);
                            }
                        });
                    } catch (e) {
                        console.error('Error calculating ODT:', e);
                    }
                    
                    let totalLSM = 0;
                    try {
                        const lsmData = typeof r.line_stop_mesin_data === 'string' ? JSON.parse(r.line_stop_mesin_data) : (r.line_stop_mesin_data || []);
                        totalLSM = lsmData.reduce((sum, l) => sum + parseFloat(l.duration || 0), 0);
                    } catch (e) {
                        console.error('Error calculating LSM:', e);
                    }
                    
                    let totalLSNM = 0;
                    try {
                        const lsnmData = typeof r.line_stop_non_mesin_data === 'string' ? JSON.parse(r.line_stop_non_mesin_data) : (r.line_stop_non_mesin_data || []);
                        totalLSNM = lsnmData.reduce((sum, l) => sum + parseFloat(l.duration || 0), 0);
                    } catch (e) {
                        console.error('Error calculating LSNM:', e);
                    }
                    
                    return [
                        r.date ? new Date(r.date).toLocaleDateString('id-ID') : '',
                        r.shift || '',
                        r.machine_name || '',
                        r.pic || '',
                        r.product_code || '',
                        r.batch_number || '',
                        r.actual_output || 0,
                        r.reject || 0,
                        r.minor_stop_count || 0,
                        (r.availability_actual || 0).toFixed(2),
                        (r.performance || 0).toFixed(2),
                        (r.quality || 0).toFixed(2),
                        (r.availability_365 || 0).toFixed(2),
                        (r.oee_actual || 0).toFixed(2),
                        (r.oee_365 || 0).toFixed(2),
                        totalODT.toFixed(2),
                        totalLSM.toFixed(2),
                        totalLSNM.toFixed(2),
                        `"${(r.notes || '').replace(/"/g, '""')}"`
                    ];
                });
                
                const csvContent = [
                    headers.join(delimiter),
                    ...rows.map(row => row.join(delimiter))
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `OEE_Export_${startDate}_to_${endDate}.xlsx`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(`‚úÖ Exported ${records.length} records to Excel`, 'success');
            } catch (e) {
                console.error('Error exporting to Excel:', e);
                showToast('Failed to export data', 'error');
            }
        }
        
        function exportToPDF(records, startDate, endDate) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                
                const config = defaultConfig;
                
                // Title
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text(config.system_title, 14, 15);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(config.company_name, 14, 22);
                
                doc.setFontSize(10);
                doc.text(`Export Period: ${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}`, 14, 28);
                doc.text(`Generated: ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID')}`, 14, 33);
                
                // Summary Statistics
                const avgOEEActual = records.length > 0 ? records.reduce((sum, r) => sum + (r.oee_actual || 0), 0) / records.length : 0;
                const avgOEE365 = records.length > 0 ? records.reduce((sum, r) => sum + (r.oee_365 || 0), 0) / records.length : 0;
                const totalOutput = records.reduce((sum, r) => sum + (r.actual_output || 0), 0);
                
                doc.setFontSize(9);
                doc.text(`Total Records: ${records.length} | Avg OEE Actual: ${avgOEEActual.toFixed(1)}% | Avg OEE 365: ${avgOEE365.toFixed(1)}% | Total Output: ${totalOutput.toLocaleString('id-ID')}`, 14, 38);
                
                // Table data
                const tableData = records.map(r => {
                    return [
                        r.date ? new Date(r.date).toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit' }) : '',
                        r.shift || '',
                        r.machine_name || '',
                        r.pic || '',
                        r.product_code || '',
                        r.batch_number || '',
                        (r.actual_output || 0).toLocaleString('id-ID'),
                        r.reject || 0,
                        (r.availability_actual || 0).toFixed(1) + '%',
                        (r.performance || 0).toFixed(1) + '%',
                        (r.quality || 0).toFixed(1) + '%',
                        (r.oee_actual || 0).toFixed(1) + '%',
                        (r.oee_365 || 0).toFixed(1) + '%'
                    ];
                });
                
                doc.autoTable({
                    startY: 42,
                    head: [['Date', 'Shift', 'Machine', 'PIC', 'Product', 'Batch', 'Output', 'Reject', 'A%', 'P%', 'Q%', 'OEE Act', 'OEE 365']],
                    body: tableData,
                    styles: { fontSize: 7, cellPadding: 2 },
                    headStyles: { fillColor: [102, 125, 234], fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [245, 247, 250] },
                    margin: { left: 14, right: 14 },
                    didDrawPage: function (data) {
                        doc.setFontSize(8);
                        doc.text(
                            `Page ${data.pageNumber} of ${doc.internal.getNumberOfPages()}`,
                            doc.internal.pageSize.width / 2,
                            doc.internal.pageSize.height - 10,
                            { align: 'center' }
                        );
                    }
                });
                
                doc.save(`OEE_Export_${startDate}_to_${endDate}.pdf`);
                showToast(`‚úÖ Exported ${records.length} records to PDF`, 'success');
            } catch (e) {
                console.error('Error exporting to PDF:', e);
                showToast('Failed to export data', 'error');
            }
        }

        // =============================================
        // FILTER & NAVIGATION FUNCTIONS
        // =============================================
        function updateFilter(key, value) {
            filters[key] = value;
            renderApp();
        }

        function getFilteredRecords() {
            return allOEERecords.filter(r => {
                if (!r.date) return false;
                
                const rDate = new Date(r.date);
                const sDate = new Date(filters.startDate);
                const eDate = new Date(filters.endDate);
                
                const dateMatch = rDate >= sDate && rDate <= eDate;
                const shiftMatch = filters.shift === 'all' || r.shift === filters.shift;
                const machineMatch = filters.machine === 'all' || r.machine_name === filters.machine;
                const picMatch = filters.pic === 'all' || r.pic === filters.pic;
                
                return dateMatch && shiftMatch && machineMatch && picMatch;
            });
        }

        function navigateTo(page) {
            currentPage = page;
            
            // Lock management when navigating away
            if (currentPage !== 'management') {
                isManagementUnlocked = false;
            }
            
            renderApp();
        }

        // =============================================
        // INITIALIZATION
        // =============================================
        async function initializeApp() {
            try {
                // Initialize theme first
                initializeTheme();
                
                // Show initial loading
                showLoading('Connecting to database...');
                
                // Load initial data
                await Promise.all([
                    loadMachines(),
                    loadOEERecords()
                ]);
                
                hideLoading();
                renderApp();
                
                // Auto-refresh data every 30 seconds
                setInterval(async () => {
                    await loadOEERecords();
                    if (currentPage === 'dashboard') {
                        renderCharts();
                    }
                }, 30000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                hideLoading();
                showToast('Failed to initialize application', 'error');
                
                // Show error screen
                const app = document.getElementById('app-wrapper');
                app.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; flex-direction: column; gap: 16px; text-align: center; padding: 20px;">
                        <h1 style="color: var(--danger); font-size: 24px; word-break: break-word;">‚ö†Ô∏è Connection Error</h1>
                        <p style="color: var(--text-secondary); word-break: break-word;">Failed to connect to database</p>
                        <button class="btn btn-primary" onclick="location.reload()">Retry</button>
                    </div>
                `;
            }
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
